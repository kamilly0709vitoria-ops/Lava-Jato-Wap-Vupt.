<!doctype html>

<html lang="pt-BR">  
<head>  
<meta charset="utf-8" />  
<meta name="viewport" content="width=device-width,initial-scale=1" />  
<title>Wap Vupt ‚Äî Agendamentos & Controle Financeiro</title>  
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">  
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />  
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>  
  /* DESIGN SOFISTICADO E MODERNO */  
  :root{  
    --bg: #f7f9fc;  
    --panel: #ffffff;  
    --muted: #6c757d;  
    --accent: #b71c1c; /* VERMELHO: O que voc√™ usa no seu tema */  
    --dark: #212529; /* PRETO/CINZA ESCURO: Cor principal */  
    --line: #e3e8f0; /* CINZA CLARO: Linhas e bordas */  
    --shadow: 0 4px 12px rgba(0,0,0,0.05);  
    --success: #28a745;  
    --danger: #dc3545;  
    --info: #1565c0;  
    --warning-bg: #fff3cd;  
    --warning-text: #856404;  
  }  
  *{box-sizing:border-box}  
  body{margin:0;font-family:'Inter', 'Segoe UI', Roboto, Arial, sans-serif;color:var(--dark);background:var(--bg);}  
  .layout{display:flex;min-height:100vh}
aside{width:80px;background:var(--dark);color:#fff;padding:18px 0;display:flex;flex-direction:column;align-items:center;gap:16px;box-shadow:2px 0 5px rgba(0,0,0,0.1);}
aside img.logo{width:50px;height:50px;border-radius:10px;object-fit:cover;border:2px solid rgba(255,255,255,0.1)}
aside .nav-btn{width:100%;background:transparent;border:0;color:#ccc;padding:12px 0;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px;font-size:11px;transition:all 0.2s}
aside .nav-btn:hover{background:rgba(255,255,255,0.05);color:#fff}
aside .nav-btn.active{background:var(--accent);color:#fff;box-shadow:inset 3px 0 0 #fff;font-weight:700}
main{flex:1;padding:25px;display:flex;flex-direction:column;gap:20px}
header.top{display:flex;align-items:center;justify-content:space-between;gap:20px;padding-bottom:10px;border-bottom:1px solid var(--line)}
.brand{display:flex;align-items:center;gap:12px}
.brand h1{margin:0;font-size:24px;font-weight:800;letter-spacing:-0.5px}
.brand .subtitle{font-size:14px;color:var(--muted)}
.card{background:var(--panel);border-radius:12px;padding:20px;box-shadow:var(--shadow);border:1px solid var(--line)}
.grid{display:grid;gap:15px}
.row{display:flex;gap:15px;align-items:center}
.col{flex:1}
.muted{color:var(--muted);font-size:14px}
.small{font-size:12px;color:var(--muted)}

table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{padding:12px 8px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
th{font-size:13px;color:var(--dark);background:var(--line);font-weight:700;text-transform:uppercase}
tr:last-child td{border-bottom:none}
.paid{color:var(--success);font-weight:700}
.not-paid{color:var(--danger);font-weight:700}

input[type=text], input[type=time], input[type=date], input[type=number], select, textarea{
width:100%;padding:12px;border-radius:8px;border:1px solid var(--line);background:var(--panel);font-size:14px;transition:border-color 0.2s
}
input:focus, select:focus, textarea:focus { border-color: var(--accent); outline: none; }
button.btn{background:var(--accent);color:#fff;padding:10px 18px;border-radius:8px;border:0;cursor:pointer;font-weight:700;transition:all 0.2s}
button.btn:hover{background:#9e0000}
button.ghost{background:transparent;border:1px solid var(--line);color:var(--dark);padding:10px 18px;border-radius:8px;transition:all 0.2s}
button.ghost:hover{background:var(--line)}
.btn-sm { padding: 6px 10px; font-size: 12px; }
.actions{display:flex;gap:10px}
.controls{display:flex;gap:10px;align-items:center}
footer{margin-top:20px;color:var(--muted);font-size:12px;text-align:center}

.finance-grid-main { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
.finance-stat-card { padding: 20px; border-radius: 10px; background: var(--panel); border-left: 5px solid; }
.finance-stat-card.in { border-left-color: var(--success); } .finance-stat-card.out { border-left-color: var(--danger); } .finance-stat-card.bal { border-left-color: var(--info); }
.finance-stat-card .label { font-size: 14px; color: var(--muted); margin-bottom: 5px; } .finance-stat-card .value { font-size: 28px; font-weight: 800; color: var(--dark); }
.daily-summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; background: #f0f4f8; border-radius: 8px; border: 1px solid var(--line); margin-bottom: 20px; }
.daily-stat { padding: 10px; background: var(--panel); border-radius: 6px; border: 1px solid #ddd; }
.daily-stat .label { font-size: 11px; color: var(--muted); } .daily-stat .value { font-size: 18px; font-weight: 700; margin-top: 2px; }

#monthlySummaryTable tbody td:nth-child(3) { color: var(--success); font-weight: 700; }
#monthlySummaryTable tbody td:nth-child(4) { color: var(--danger); font-weight: 700; }
#monthlySummaryTable tbody td:nth-child(5) { font-weight: 800; }

#cash-info-today { display: none; }

.edit-mode input, .edit-mode select { padding: 4px; font-size: 13px; margin: -4px 0; border: 1px solid var(--accent); }

.client-history-item { padding: 8px; margin-bottom: 5px; border-radius: 4px; background: #f0f8ff; border: 1px solid var(--line); cursor: pointer; transition: background 0.2s; }
.client-history-item:hover { background: #e6f7ff; }
.client-history-item .service-name { font-weight: 700; color: var(--dark); font-size: 14px; }
.client-history-item .details { font-size: 11px; color: var(--muted); margin-top: 2px; display: flex; justify-content: space-between; }

.client-name-clickable { font-weight: 700; cursor: pointer; color: var(--dark); transition: color 0.2s; }
.client-name-clickable:hover { color: var(--accent); text-decoration: underline; }

.past-date-alert { margin-top: 10px; padding: 8px; border-radius: 6px; background-color: var(--warning-bg); color: var(--warning-text); font-weight: 700; font-size: 13px; display: flex; align-items: center; gap: 8px; border: 1px solid #ffeeba; }

/* Estilo para sugest√£o de nomes */
.autocomplete-container { position: relative; }
.autocomplete-list { position: absolute; z-index: 10; width: 100%; max-height: 150px; overflow-y: auto; background: var(--panel); border: 1px solid var(--line); border-top: none; border-radius: 0 0 8px 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
.autocomplete-item { padding: 8px 12px; cursor: pointer; font-size: 14px; }
.autocomplete-item:hover { background: #f0f4f8; }

/* Estilo para formas de pagamento no novo agendamento */
.payment-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }

/* NOVO: Estilo para o cabe√ßalho da nota (Logo + Info) */
.note-header-v5 { 
    display: flex; 
    align-items: center; 
    justify-content: flex-start; /* Alinhado √† esquerda como solicitado */
    border-bottom: 1px solid #eee; 
    padding-bottom: 10px; 
    margin-bottom: 10px;
}
.note-header-v5 img {
    width: 60px; /* Tamanho da logo na nota */
    height: 60px;
    object-fit: cover;
    border-radius: 8px;
    margin-right: 10px;
}
.note-header-v5 .info {
    text-align: left;
}
.note-header-v5 h3 { 
    margin: 0; 
    color: var(--dark);
    font-size: 16px;
}
.note-header-v5 p { 
    margin: 0; 
    font-size: 10px; 
    color: var(--muted);
    font-weight: 700;
}


@media (max-width:880px){ aside{width:60px} .brand h1{font-size:20px} .finance-grid-main, .daily-summary { grid-template-columns: 1fr; } }

</style>

</head>  
<body>  
<div class="layout">  
  <aside>  
    <img id="sideLogo" class="logo" src="" style="display:none" alt="Logo">  
    <button class="nav-btn active" data-view="today" title="Agendamentos" onclick="nav(this)"><i class="fa-solid fa-calendar-days"></i><div style="font-size:11px">Hoje</div></button>  
    <button class="nav-btn" data-view="new" title="Novo" onclick="nav(this)"><i class="fa-solid fa-plus"></i><div style="font-size:11px">Novo</div></button>  
    <button class="nav-btn" data-view="calendar" title="Calend√°rio" onclick="nav(this)"><i class="fa-solid fa-calendar"></i><div style="font-size:11px">Agenda</div></button>  
    <button class="nav-btn" data-view="history" title="Hist√≥rico" onclick="nav(this)"><i class="fa-solid fa-list-ul"></i><div style="font-size:11px">Hist√≥rico</div></button>  
    <button class="nav-btn" data-view="admin" title="Admin" onclick="nav(this)"><i class="fa-solid fa-gauge-high"></i><div style="font-size:11px">Admin</div></button>  
    <div style="flex:1"></div>  
    <div style="font-size:10px;color:#bbb">Wap Vupt v5.0</div>  
  </aside>    
  <main>  
    <header class="top">  
      <div class="brand">  
        <h1 id="titleApp">Wap Vupt </h1>  
        <div class="subtitle muted">Agendamentos ‚Ä¢ Caixa ‚Ä¢ Controle ‚Ä¢ <span id="headerNoteLabel">Nota/Or√ßamento</span></div>  
      </div>  
      <div class="controls">  
        <div class="small muted" id="clock">--:--</div>  
        <button class="btn ghost btn-sm" onclick="exportData()"><i class="fa-solid fa-file-export"></i> Exportar</button>  
        <button class="btn btn-sm" onclick="downloadJson()"><i class="fa-solid fa-database"></i> Backup</button>  
      </div>  
    </header>  
    
<section id="view-today" class="card" style="padding:15px">  
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">  
    <div>  
      <div class="muted">Agendamentos de</div>  
      <div style="font-weight:800;font-size:20px" id="todayLabel"></div>  
      <div class="muted small" id="todayCount">0 agendamentos</div>  
    </div>  
    <div class="card" style="padding:15px;width:300px">  
      <h4>Fila de Hoje</h4>  
      <div style="display:flex;flex-direction:column;gap:10px">  
        <div class="row"><div style="flex:1">Total agendamentos</div><div id="rushCount" style="font-weight:700">0</div></div>  
        <div class="row"><div style="flex:1">Pendentes de pagamento</div><div id="pendingCount" style="color:var(--danger);font-weight:700">0</div></div>  
        <div class="row"><div style="flex:1">Recebido hoje</div><div id="collectedToday" style="font-weight:800;color:var(--success)">R$ 0,00</div></div>  
      </div>  
      <div style="margin-top:20px" class="row">  
        <button class="btn ghost btn-sm" onclick="printToday()"><i class="fa-solid fa-print"></i> Imprimir</button>  
        <button class="btn ghost btn-sm" onclick="clearToday()">Limpar Dia</button>  
      </div>  
    </div>  
  </div>  

  <div style="margin-top:15px">  
    <table id="tableToday">  
      <thead><tr><th>#</th><th>Cliente</th><th>Servi√ßo</th><th>Hora (In√≠cio / Sa√≠da)</th><th>Valor</th><th>Status</th><th>A√ß√µes</th><th>Nota</th></tr></thead>  
      <tbody></tbody>  
    </table>  
  </div>  
</section>  

<section id="view-new" class="card" style="display:none">  
  <h3>Novo Agendamento / Registro de Servi√ßo</h3>  
  <form id="formNew" onsubmit="createSchedule(event)">  
    <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:15px">  
      <div class="autocomplete-container">  
        <label class="muted small">Nome do cliente</label>  
        <input type="text" id="inputName" required oninput="loadClientHistory(this.value); showNameSuggestions(this.value)">  
        <div id="nameSuggestions" class="autocomplete-list" style="display:none;"></div>
      </div>  
      <div>  
        <label class="muted small">Tipo de Servi√ßo</label>  
        <select id="inputVehicle" onchange="renderServiceOptions(); updateTimeDetails();">  
          <option value="moto">Moto</option>  
          <option value="carro">Carro</option>  
          <option value="outros">Estofado / Outros</option>  
        </select>  
      </div>  
      <div>  
        <label class="muted small">Data do Servi√ßo/Agendamento</label>  
        <input type="date" id="inputDate" min="2024-01-01" max="2028-12-31" required onchange="updateTimeDetails(); updatePastDateWarning()">  
      </div>  
      <div>  
        <label class="muted small">Servi√ßo principal</label>  
        <select id="inputService" required onchange="updateTimeDetails()"></select>  
      </div>  
      <div>  
        <label class="muted small">Hora de in√≠cio (Aprox.)</label>  
        <input type="time" id="inputTime" onchange="updateTimeDetails()">  
      </div>  
      <div>  
         <label class="muted small">Previs√£o de Sa√≠da / Tempo Total</label>  
         <input type="text" id="endTime" readonly style="background:#f9f9f9;font-weight:700;color:var(--info);" value="--:--">  
      </div>  
    </div>  

    <div id="pastDateWarning" class="past-date-alert" style="display:none; margin-top:15px;">  
        <i class="fa-solid fa-triangle-exclamation"></i>  
        Data anterior/passada selecionada! Registrando como **Servi√ßo Realizado (Hist√≥rico)**.  
    </div>  

    <div id="clientHistoryContainer" style="margin-top:15px; border:1px solid var(--line); padding:10px; border-radius:8px; display:none;">  
        <label class="muted small">Agendamentos Passados</label>  
        <div id="clientHistoryList" style="max-height:150px; overflow-y:auto; padding-right: 5px;"></div>  
        <div class="muted small" style="margin-top:5px; text-align:right;">Clique para preencher campos.</div>  
    </div>  

    <div style="margin-top:20px">  
      <label class="muted small">Adicionais</label>  
      <div id="inputAdds" style="display:flex;flex-wrap:wrap;gap:15px;border:1px solid var(--line);padding:10px;border-radius:8px;"></div>  
    </div>  

    <div style="margin-top:12px; display:flex; gap:10px; align-items:center;">  
      <div style="flex:1">  
        <label class="muted small">Desconto (%) <span class="small muted">(Apenas informativo.)</span></label>  
        <input type="number" id="inputDiscount" min="0" max="100" placeholder="Ex: 10" onchange="updateTimeDetails()">  
      </div>  
      <div style="width:260px">  
        <label class="muted small">Valor Total (Final/Edit√°vel)</label>  
        <input type="number" id="inputTotalWithDiscount" step="0.01" style="background:var(--panel);font-weight:800;color:var(--accent);">  
      </div>  
    </div>  
    
    <div id="paymentOptionContainer" style="margin-top:12px;">  
        <input type="checkbox" id="inputMarkPaid" onchange="togglePaymentDetails(this.checked)">  
        <label for="inputMarkPaid" class="small muted">Marcar como <strong>Pago</strong> ao registrar (servi√ßo conclu√≠do/hist√≥rico)</label>  

        <div id="paymentDetails" class="payment-grid" style="display:none;">
            <div>
                <label class="muted small">Forma de Pagamento</label>
                <select id="inputPaymentMethod" onchange="calculateFinalValueWithFee()">
                    <option value="dinheiro">Dinheiro</option>
                    <option value="pix">PIX</option>
                    <option value="debito">Cart√£o de D√©bito</option>
                    <option value="credito">Cart√£o de Cr√©dito</option>
                </select>
            </div>
             <div>
                <label class="muted small">Valor a Entrar no Caixa <i class="fa-solid fa-calculator" title="Valor descontado das taxas."></i></label>
                <input type="number" id="inputPaidValueWithFee" step="0.01" readonly style="background:#f9f9f9;font-weight:700;color:var(--success);">
            </div>
        </div>
    </div>  

    <div style="margin-top:20px" class="row">  
      <button class="btn" type="submit"><i class="fa-solid fa-calendar-check"></i> Confirmar / Registrar Servi√ßo</button>  
      <button class="btn ghost" type="button" onclick="resetNewForm()">Limpar</button>  
    </div>  
  </form>  
</section>  

<section id="view-calendar" class="card" style="display:none">  
  <h3>Calend√°rio de Agendamentos</h3>  
  <div class="row">  
    <div style="flex:1">  
      <label class="muted small">Escolha uma data</label>  
      <input type="date" id="calendarDate" min="2024-01-01" max="2028-12-31" onchange="showDate()" />  
    </div>  
    <div style="width:250px">  
      <label class="muted small">Buscar por cliente</label>  
      <input type="text" id="searchClient" placeholder="Digite o nome do cliente" oninput="showDate()" />  
    </div>  
  </div>  
  <div style="margin-top:15px">  
    <table id="tableCalendar">
      <thead><tr><th>Data</th><th>Cliente</th><th>Servi√ßo</th><th>Hora (In√≠cio / Sa√≠da)</th><th>Valor</th><th>Status</th><th>A√ß√µes</th><th>Nota</th></tr></thead>
      <tbody></tbody>
    </table>  
  </div>  
</section>  

<section id="view-history" class="card" style="display:none">  
  <h3>Hist√≥rico Completo</h3>  
  <div id="historyAccess" style="display:none;">
    <button class="btn" onclick="promptAdminPasswordForHistory()"><i class="fa-solid fa-lock"></i> Desbloquear Hist√≥rico</button>
  </div>
  <div id="historyContent" style="display:block;">
    <div class="row" style="margin-bottom:15px">  
      <div class="col">  
        <label class="muted small">Pesquisar por Cliente/Servi√ßo</label>  
        <input type="text" id="historySearchInput" placeholder="Digite o nome do cliente ou servi√ßo" oninput="loadHistory()">  
      </div>  
      <div style="width:150px">  
        <label class="muted small">Status</label>  
        <select id="historyStatusFilter" onchange="loadHistory()">  
          <option value="">Todos</option>  
          <option value="pendente">Pendente</option>  
          <option value="pago">Pago</option>  
        </select>  
      </div>  
    </div>  
    <div class="muted small" id="historyCountLabel">Lista dos agendamentos mais recentes (m√°x. 200).</div>  
    <div style="margin-top:15px">  
      <table>  
        <thead><tr><th>Data</th><th>Cliente</th><th>Servi√ßo</th><th>Hora (In√≠cio / Sa√≠da)</th><th>Tempo</th><th>Valor</th><th>Pagto</th><th>Status</th><th>A√ß√µes</th><th>Nota</th></tr></thead>  
        <tbody id="tableHistoryBody"></tbody>  
      </table>  
    </div>
  </div>
</section>  

<section id="view-admin" class="card" style="display:none">  
  <h3>√Årea Administrativa e Financeira</h3>  

  <h4 style="margin-top:10px">Resumo Financeiro - Hoje (<span id="adminTodayDate"></span>)</h4>  
  <div class="daily-summary">  
      <div class="daily-stat">  
          <div class="label">Entradas do Dia (Caixa)</div>  
          <div class="value" id="dailyEntries">R$ 0,00</div>  
      </div>  
      <div class="daily-stat">  
          <div class="label">Despesas do Dia</div>  
          <div class="value" id="dailyExpenses">R$ 0,00</div>  
      </div>  
      <div class="daily-stat">  
          <div class="label">Saldo do Dia (Entradas - Sa√≠das)</div>  
          <div class="value" id="dailyBalance">R$ 0,00</div>  
      </div>  
  </div>  

  <h4 style="margin-top:0px">Dashboard de Fluxo de Caixa (Total Geral)</h4>  
  <div class="finance-grid-main">  
    <div class="finance-stat-card in">  
      <div class="label">Total de Entradas (Receitas)</div>  
      <div class="value" id="dashTotalEntries">R$ 0,00</div>  
      <div class="detail">Soma de todos os pagamentos (l√≠quido).</div>  
    </div>  
    <div class="finance-stat-card out">  
      <div class="label">Total de Sa√≠das (Despesas + Taxas)</div>  
      <div class="value" id="dashTotalExpenses">R$ 0,00</div>  
      <div class="detail">Soma de despesas e taxas de cart√£o.</div>
        </div>
        <div class="finance-stat-card bal">
          <div class="label">Saldo Final (Atual)</div>
          <div class="value" id="dashBalance">R$ 0,00</div>
          <div class="detail">Saldo Inicial + Entradas - Sa√≠das.</div>
        </div>
      </div>
      
      <div class="card" style="margin-top:15px">
        <h4>Resumo de Saldo Di√°rio do M√™s Atual (<span id="monthlyLabel"></span>)</h4>
        <div style="max-height:400px;overflow-y:auto">
          <table id="monthlySummaryTable">
            <thead>
              <tr>
                <th>Dia</th>
                <th>Data</th>
                <th>Entradas (R$)</th>
                <th>Sa√≠das (R$)</th>
                <th>Saldo Di√°rio (R$)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="grid" style="grid-template-columns:1fr 1fr;gap:15px;margin-top:15px">
        <div class="card">
          <h4>Configura√ß√µes Gerais e Seguran√ßa</h4>
          <label class="muted small">Nome do estabelecimento</label>
          <input type="text" id="brandNameInput">
          <label class="muted small">Logo (opcional)</label>
          <input type="file" id="logoFile" accept="image/*">
          <div id="logoPreview" style="margin-top: 10px; display: none; padding: 5px; border: 1px dashed var(--line); border-radius: 8px;">
            <img id="currentLogo" style="max-width: 100px; max-height: 100px; display: block;" alt="Logo Atual">
            <span class="small muted" style="margin-top: 5px;">Logo atual.</span>
          </div>
          <label class="muted small" style="margin-top: 10px;">Senha administrativa</label>
          <input type="text" id="adminPassInput" placeholder="Deixe vazio para n√£o alterar">
          <div style="margin-top:15px" class="row">
            <button class="btn" onclick="saveConfig()"><i class="fa-solid fa-save"></i> Salvar Configura√ß√µes</button>
            <button class="btn ghost" onclick="resetConfig()">Resetar Dados</button>
          </div>
        </div>

        <div class="card">
          <h4>Configura√ß√µes de Fluxo de Caixa / Taxas</h4>
          <div class="row">
            <div class="col">
              <div class="muted small">Saldo de Abertura (Caixa Inicial)</div>
              <input type="number" id="initialCash" min="0" step="0.01">
            </div>
            <div style="width:120px;padding-top:20px">
              <button class="btn" onclick="setInitialCash()">Salvar</button>
            </div>
          </div>
          <hr style="margin: 15px 0; border: 0; border-top: 1px dashed var(--line);">
          <label class="muted small">Taxa D√©bito (%)</label>
          <input type="number" id="feeDebito" min="0" max="100" step="0.01" style="margin-bottom: 8px;">
          <label class="muted small">Taxa Cr√©dito (%)</label>
          <input type="number" id="feeCredito" min="0" max="100" step="0.01">
          <div style="margin-top:10px" class="row">
            <button class="btn" onclick="saveFees()"><i class="fa-solid fa-save"></i> Salvar Taxas</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:15px">
        <h4>Gest√£o de Servi√ßos e Pre√ßos</h4>
        <div class="muted small">Clique em um campo para editar (Nome, Categoria, Pre√ßo, Tempo) e use <i class="fa-solid fa-save"></i> para salvar.</div>
        <table id="servicesTable">
            <thead><tr><th>Nome</th><th>Categoria</th><th>Tipo</th><th>Pre√ßo</th><th>Tempo (min)</th><th>A√ß√µes</th></tr></thead>
            <tbody></tbody>
        </table>
        
        <div style="margin-top:15px">
          <div class="grid" style="grid-template-columns:repeat(5,1fr);gap:8px">
            <input type="text" id="svcName" placeholder="Nome do servi√ßo">
            <select id="svcCategory"><option value="both">Ambos</option><option value="moto">Moto</option><option value="carro">Carro</option><option value="outros">Outros</option></select>
            <select id="svcIsAdd"><option value="false">Principal</option><option value="true">Adicional</option></select>
            <input type="number" id="svcPrice" placeholder="Pre√ßo (R$)" min="0" step="0.01">
            <input type="number" id="svcTime" placeholder="Tempo (min)" min="0">
          </div>
          <div style="margin-top:10px" class="row">
            <button class="btn" onclick="addService()"><i class="fa-solid fa-plus"></i> Adicionar Servi√ßo</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:15px">
        <h4>Movimenta√ß√µes e Despesas</h4>
        <div class="grid" style="grid-template-columns:1fr 1fr 1fr;gap:15px">
          <div>
            <label class="muted small">Registrar Nova Despesa</label>
            <input type="text" id="expDesc" placeholder="Descri√ß√£o da despesa" style="margin-bottom:8px">
            <input type="number" id="expValue" placeholder="Valor (R$)" min="0" step="0.01">
            <div style="margin-top:10px"><button class="btn" onclick="addExpense()"><i class="fa-solid fa-money-bill-transfer"></i> Registrar Despesa</button></div>
          </div>
          <div>
            <label class="muted small">Entradas (Receitas)</label>
            <div id="listEntries" style="max-height:280px;overflow-y:auto;border:1px solid var(--line);padding:8px;border-radius:8px"></div>
          </div>
          <div>
            <label class="muted small">Hist√≥rico de Despesas (Admin)</label>
            <div id="listExpenses" style="max-height:280px;overflow-y:auto;border:1px solid var(--line);padding:8px;border-radius:8px">
            </div>
            <button class="btn ghost btn-sm" style="width:100%; margin-top: 8px;" onclick="openExpenseHistoryModal()"><i class="fa-solid fa-file-invoice-dollar"></i> Ver/Editar Hist√≥rico Completo</button>
          </div>
        </div>
      </div>

    </section>
    <footer class="muted small">App offline ‚Äî dados salvos apenas no seu dispositivo. Desenvolvido com sofistica√ß√£o e controle.</footer>
  </main>
</div>

<div id="editServiceModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div class="card" style="width:450px; padding:20px;">
        <h4 style="margin-top:0;">Editar Agendamento (Admin)</h4>
        <form id="formEditSchedule" onsubmit="saveScheduleEdit(event)">
            <input type="hidden" id="editScheduleId">

            <div class="grid" style="grid-template-columns:1fr 1fr; gap: 15px;">
                <div>
                    <label class="muted small">Cliente (Nome)</label>
                    <input type="text" id="editClientNameInput" required>
                </div>
                <div>
                    <label class="muted small">Tipo de Servi√ßo</label>
                    <select id="editVehicle" onchange="renderEditServiceOptions(); updateEditServiceDetails();">
                        <option value="moto">Moto</option>
                        <option value="carro">Carro</option>
                        <option value="outros">Estofado / Outros</option>
                    </select>
                </div>
            </div>

            <div class="grid" style="grid-template-columns:1fr 1fr; gap: 15px; margin-top: 15px;">
                <div>
                    <label class="muted small">Data</label>
                    <input type="date" id="editDate" required>
                </div>
                <div>
                    <label class="muted small">Hora de In√≠cio</label>
                    <input type="time" id="editTime" required onchange="updateEditServiceDetails()">
                </div>
            </div>

            <div style="margin-top:15px;">
                <label class="muted small">Servi√ßo Principal</label>
                <select id="editService" required onchange="updateEditServiceDetails()"></select>
            </div>
            
            <div style="margin-top:15px;">
                <label class="muted small">Adicionais</label>
                <div id="editAdds" style="display:flex;flex-wrap:wrap;gap:15px;border:1px solid var(--line);padding:10px;border-radius:8px;"></div>
            </div>

            <div style="margin-top:15px;" class="row">
                <div style="flex:1;">
                    <label class="muted small">Dura√ß√£o (minutos)</label>
                    <input type="number" id="editTempoInput" min="0" required oninput="updateEditServiceDetails(true)">
                </div>
                <div style="flex:1;">
                    <label class="muted small">Previs√£o de Sa√≠da</label>
                    <input type="text" id="editEndTime" readonly style="background:#f9f9f9;font-weight:700;color:var(--info);">
                </div>
            </div>

            <div style="margin-top:12px;">
              <label class="muted small">Valor Final (Com Desconto)</label>
              <input type="number" id="editValor" step="0.01" style="background:var(--panel);font-weight:800;color:var(--accent);">
            </div>
            
            <input type="hidden" id="editDiscount" value="0"> 

            <div style="margin-top:12px;">
              <label class="muted small">Status/Forma de Pagamento (Se Pago)</label>
              <select id="editPaymentMethod">
                    <option value="dinheiro">Dinheiro</option>
                    <option value="pix">PIX</option>
                    <option value="debito">D√©bito</option>
                    <option value="credito">Cr√©dito</option>
                    <option value="pendente">Pendente</option>
              </select>
            </div>

            <div style="margin-top:20px" class="row">
                <button class="btn" type="submit"><i class="fa-solid fa-save"></i> Salvar Edi√ß√£o</button>
                <button class="btn ghost" type="button" onclick="closeEditModal()">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<div id="expenseHistoryModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div class="card" style="width:700px; padding:20px;">
        <h4 style="margin-top:0;">Hist√≥rico Completo de Despesas</h4>
        <div style="max-height: 400px; overflow-y: auto;">
            <table id="expenseHistoryTable">
                <thead><tr><th>Data/Hora</th><th>Descri√ß√£o</th><th>Valor</th><th>A√ß√µes</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <div style="margin-top:20px; text-align: right;">
            <button class="btn ghost" type="button" onclick="closeExpenseHistoryModal()">Fechar</button>
        </div>
    </div>
</div>

<div id="imageNoteContainer" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1001; display:none; justify-content:center; align-items:center;">
    <div class="card" style="width:350px; padding:0; box-shadow:none; border:none;">
        <div id="noteContentToImage" style="background:#ffffff; padding:20px; border-radius:10px; font-family:'Inter', sans-serif;">
            
            <div class="note-header-v5">
                <img id="noteLogo" src="" alt="Logo" style="display:none;">
                <div class="info">
                    <h3 id="noteBrandName">WAP VUPT</h3>
                    <p id="noteTypeLabel">OR√áAMENTO/NOTA (N√ÉO FISCAL)</p>
                </div>
            </div>
            <div id="noteClientDetails" style="font-size:12px; margin-bottom:10px;"></div>
            <div id="noteItemsList" style="margin-bottom:15px;"></div>
            
            <div id="notePaymentInfo" style="font-size:12px; margin-bottom:10px;"></div>
            <div style="border-top:2px solid #333; padding-top:10px; text-align:right;">
                <div style="font-size:18px; font-weight:800; color:var(--accent);">TOTAL: <span id="noteFinalValue" style="color:var(--accent);"></span></div>
            </div>
            <p style="text-align:center; font-size:10px; color:var(--muted); margin-top:15px;">
                Obrigado pela prefer√™ncia!
            </p>
        </div>
        <div style="padding:10px; background:var(--dark); border-bottom-left-radius:10px; border-bottom-right-radius:10px; text-align:center;">
            <button class="btn btn-sm" onclick="downloadImageNote()" style="background:#28a745; margin-right:5px;"><i class="fa-solid fa-download"></i> Baixar PNG</button>
            <button class="btn ghost btn-sm" onclick="printThermalNoteWrapper()" style="color:#fff; border-color:#fff; background-color:#1565c0;"><i class="fa-solid fa-print"></i> Imprimir T√©rmica</button>
            <button class="btn ghost btn-sm" onclick="$('imageNoteContainer').style.display='none'" style="color:#fff; border-color:#fff;"><i class="fa-solid fa-xmark"></i> Fechar</button>
        </div>
    </div>
</div>

<script>
/* ============================ DATA & DEFAULTS ============================ */
const KEY = 'wap_vupt_app_v5_0' // VERS√ÉO ATUALIZADA
const DEFAULT = {
  brand: {name:'Wap Vupt', logo:''},
  adminPass: '1234',
  initialCash: 0,
  fees: {debito: 2.00, credito: 3.50},
  services: [
    {id:idGen(), name:'Moto Pequena - Lavagem', category:'moto', isAdd:false, price:5.00, time:25},
    {id:idGen(), name:'Moto Grande - Lavagem', category:'moto', isAdd:false, price:7.00, time:25},
    {id:idGen(), name:'Carro - Lavagem + Pretinho', category:'carro', isAdd:false, price:15.00, time:30},
    {id:idGen(), name:'Estofado - Sof√° 2 Lugares', category:'outros', isAdd:false, price:50.00, time:120},
    {id:idGen(), name:'Moto - Hidrata√ß√£o', category:'moto', isAdd:true, price:5.00, time:10},
    {id:idGen(), name:'Moto - Cera', category:'moto', isAdd:true, price:5.00, time:5},
    {id:idGen(), name:'Moto - Verniz', category:'moto', isAdd:true, price:10.00, time:15},
    {id:idGen(), name:'Carro - Aspira√ß√£o', category:'carro', isAdd:true, price:10.00, time:30},
    {id:idGen(), name:'Carro - Hidrata√ß√£o', category:'carro', isAdd:true, price:10.00, time:30},
    {id:idGen(), name:'Carro - Cera', category:'carro', isAdd:true, price:16.00, time:30},
    {id:idGen(), name:'Carro - Verniz', category:'carro', isAdd:true, price:15.00, time:30},
    {id:idGen(), name:'G√°s', category:'both', isAdd:true, price:3.00, time:5},
  ],
  schedules: [],
  entries: [],
  expenses: []
}
function idGen(){ return 'id'+Math.random().toString(36).slice(2,9) }
function load(){ 
  try{ 
    const loadedData = JSON.parse(localStorage.getItem(KEY));
    let finalData = loadedData ? {...JSON.parse(JSON.stringify(DEFAULT)), ...loadedData} : JSON.parse(JSON.stringify(DEFAULT));
    if (!finalData.fees) finalData.fees = DEFAULT.fees;
    if (!finalData.services.some(s => s.category === 'outros')) {
         finalData.services.push(DEFAULT.services.find(s=>s.category==='outros'));
    }
    return finalData;
  }catch{ 
    return JSON.parse(JSON.stringify(DEFAULT)) 
  } 
}
let DATA = load()
function save(){ localStorage.setItem(KEY, JSON.stringify(DATA)); refreshAll() }

/* ============================ UI HELPERS ============================ */
function $(id){ return document.getElementById(id) }
function money(v){ return 'R$ ' + Number(v||0).toFixed(2).replace('.',',') }
function todayStr(){ return new Date().toISOString().slice(0,10) }
function parseTimeToMins(t){ if(!t) return 0; const [h,m]=t.split(':').map(Number); return h*60+m }
function addMinsToTime(t,mins){ const total=parseTimeToMins(t)+mins; const totalMins = ((total%1440)+1440)%1440; const hh=Math.floor(totalMins/60); const mm=totalMins%60; return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}` }
function formatDateBR(dateStr){ const [y,m,d] = dateStr.split('-'); return `${d}/${m}/${y}` }
function applyDiscount(value, percent){ percent = Number(percent) || 0; if(percent <= 0) return Number(value); return Number((value * (1 - (percent/100))).toFixed(2)); }
function parsePaymentMethod(method) {
    if (!method) return '';
    const map = {
        dinheiro: 'Dinheiro',
        pix: 'PIX',
        debito: 'Cart√£o de D√©bito',
        credito: 'Cart√£o de Cr√©dito',
        pendente: 'Pendente'
    };
    return map[method.toLowerCase()] || method;
}

// Fun√ß√£o isTimeSlotOccupied (Valida√ß√£o de Conflito)
function isTimeSlotOccupied(newStartTime, durationMinutes, date, excludeId = null) {
    if (!newStartTime || !durationMinutes || durationMinutes <= 0 || !date) return false;
    const newStartMins = parseTimeToMins(newStartTime);
    const newEndMins = newStartMins + durationMinutes;
    const existingSchedules = DATA.schedules.filter(s => 
        s.date === date && s.id !== excludeId && s.time 
    );
    for (const s of existingSchedules) {
        const existingStartMins = parseTimeToMins(s.time);
        const existingEndMins = existingStartMins + s.tempo;
        const overlap = ((newStartMins < existingEndMins && newEndMins > existingStartMins));
        if (overlap) {
            alert(`üö´ Conflito de hor√°rio! O agendamento de ${s.name} est√° marcado das ${s.time}h √†s ${addMinsToTime(s.time, s.tempo)}h. Escolha outro hor√°rio.`);
            return true;
        }
    }
    return false;
}

// Aplica taxa de pagamento (Ex: D√©bito)
function calculateValueWithFee(value, method) {
    if (method === 'debito') {
        const fee = DATA.fees.debito / 100;
        return Number((value * (1 - fee)).toFixed(2));
    }
    if (method === 'credito') {
        const fee = DATA.fees.credito / 100;
        return Number((value * (1 - fee)).toFixed(2));
    }
    return Number(value);
}

// Calcula o valor l√≠quido do servi√ßo no form Novo
function calculateFinalValueWithFee() {
    const finalValue = Number($('inputTotalWithDiscount').value) || 0;
    const method = $('inputPaymentMethod').value;
    const netValue = calculateValueWithFee(finalValue, method);
    $('inputPaidValueWithFee').value = netValue.toFixed(2);
}

/* ============================ NAVIGATION ============================ */
function nav(btn){
  document.querySelectorAll('aside .nav-btn').forEach(b=>b.classList.remove('active'))
  btn.classList.add('active')
  const view = btn.dataset.view
  let accessGranted = true;

  if (view === 'admin') {
    const pass = prompt('üîê Senha administrativa:'); 
    if(pass !== DATA.adminPass){ alert('üö´ Senha incorreta!'); accessGranted = false; }
  } else if (view === 'history') { // Manter a l√≥gica de senha de entrada na tela de hist√≥rico
    const pass = prompt('üîê Senha administrativa para Hist√≥rico:'); 
    if(pass !== DATA.adminPass){ 
        alert('üö´ Senha incorreta! Acesso n√£o autorizado.'); 
        accessGranted = false; 
    } else {
        $('historyAccess').style.display = 'none';
        $('historyContent').style.display = 'block';
    }
  }

  if(accessGranted){
    ['today','new','calendar','history','admin'].forEach(v=> $('view-'+v).style.display='none')
    $('view-'+view).style.display='block'
    if(view==='today') loadToday()
    if(view==='new') resetNewForm() 
    if(view==='calendar'){ $('calendarDate').value = todayStr(); showDate() }
    if(view==='history') loadHistory()
    if(view==='admin') loadAdmin()
  } else {
    document.querySelector('[data-view="today"]').classList.add('active');
    $('view-today').style.display='block';
    loadToday();
  }
}

// Fun√ß√£o para desbloquear o hist√≥rico (chamada pelo bot√£o, se o usu√°rio estiver na tela de hist√≥rico sem senha)
function promptAdminPasswordForHistory() {
    nav(document.querySelector('[data-view="history"]'));
}

/* NOVO: Fun√ß√£o para solicitar senha e abrir a edi√ß√£o */
function promptAdminPasswordForEdit(scheduleId) {
    const pass = prompt('üîê Senha administrativa para Edi√ß√£o:'); 
    if(pass !== DATA.adminPass){ 
        alert('üö´ Senha incorreta! Acesso para edi√ß√£o n√£o autorizado.'); 
        return; 
    }
    editScheduleService(scheduleId);
}

/* ============================ BRAND & CLOCK ============================ */
function renderBrand(){ 
  $('titleApp').innerText = DATA.brand.name || 'Wap Vupt'; 
  $('titleApp').title = DATA.brand.name || 'Wap Vupt'; 
  $('noteBrandName').innerText = DATA.brand.name.toUpperCase() || 'WAP VUPT'; 
  
  // LOGO
  if(DATA.brand.logo){ 
    $('sideLogo').src = DATA.brand.logo; 
    $('sideLogo').style.display='block';
    $('noteLogo').src = DATA.brand.logo;
    $('noteLogo').style.display='block';
    $('currentLogo').src = DATA.brand.logo;
    $('logoPreview').style.display = 'block';
  } else { 
    $('sideLogo').style.display='none'; 
    $('noteLogo').style.display='none';
    $('logoPreview').style.display = 'none';
  } 
}
function updateClock(){ $('clock').innerText = new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}) }
setInterval(updateClock,1000);

/* ============================ FINANCE / BALANCE ============================ */
function calculateBalance(dateStr = null){
  let entries = DATA.entries;
  let expenses = DATA.expenses;
  let initial = DATA.initialCash;
  
  const cardFees = DATA.schedules
    .filter(s => s.paid && (s.paymentMethod === 'credito' || s.paymentMethod === 'debito'))
    .reduce((sum, s) => {
        const netValue = calculateValueWithFee(s.valor, s.paymentMethod);
        const fee = s.valor - netValue;
        if (dateStr && s.paidAt && !s.paidAt.startsWith(dateStr)) return sum;
        return sum + fee;
    }, 0);

  if (dateStr) {
    const dateFilter = (item) => item.time.startsWith(dateStr);
    entries = entries.filter(dateFilter);
    expenses = expenses.filter(dateFilter);
    initial = 0;
  }
  
  const totalEntries = entries.reduce((sum, e) => sum + e.value, 0)
  const totalExpenses = expenses.reduce((sum, e) => sum + e.value, 0) + cardFees; 
  const currentBalance = initial + totalEntries - totalExpenses
  
  return { initial: initial, entries: totalEntries, expenses: totalExpenses, balance: currentBalance, cardFees: cardFees }
}

function calculateMonthlySummary() {
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const monthlySummary = {};
  const monthPrefix = `${year}-${String(month + 1).padStart(2, '0')}`;
  const monthEntries = DATA.entries.filter(e => e.time.startsWith(monthPrefix));
  const monthExpenses = DATA.expenses.filter(e => e.time.startsWith(monthPrefix));
  
  for (let day = 1; day <= daysInMonth; day++) {
      const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      
      const dayEntries = monthEntries.filter(e => e.time.startsWith(dateStr)).reduce((sum, e) => sum + e.value, 0);
      const dayExpenses = monthExpenses.filter(e => e.time.startsWith(dateStr)).reduce((sum, e) => sum + e.value, 0);

      const dayFees = DATA.schedules
        .filter(s => s.paid && s.paidAt && s.paidAt.startsWith(dateStr) && (s.paymentMethod === 'credito' || s.paymentMethod === 'debito'))
        .reduce((sum, s) => sum + (s.valor - calculateValueWithFee(s.valor, s.paymentMethod)), 0);

      const totalDayExpenses = dayExpenses + dayFees;
      const dayBalance = dayEntries - totalDayExpenses;
      
      if (dayEntries > 0 || totalDayExpenses > 0 || dateStr === todayStr()) {
        monthlySummary[dateStr] = { dateStr, day, entries: dayEntries, expenses: totalDayExpenses, balance: dayBalance };
      }
  }
  return monthlySummary;
}

function refreshAll(){
  renderBrand()
  const balance = calculateBalance()
  $('dashTotalEntries').innerText = money(balance.entries)
  $('dashTotalExpenses').innerText = money(balance.expenses) 
  $('dashBalance').innerText = money(balance.balance)
  const todayBalance = calculateBalance(todayStr())
  $('adminTodayDate').innerText = formatDateBR(todayStr())
  $('dailyEntries').innerText = money(todayBalance.entries)
  $('dailyExpenses').innerText = money(todayBalance.expenses) 
  $('dailyBalance').innerText = money(todayBalance.balance)
  const schedulesToday = DATA.schedules.filter(s => s.date === todayStr())
  const collectedToday = schedulesToday.filter(s => s.paid).reduce((sum, s) => sum + s.paidValue, 0)
  $('collectedToday').innerText = money(collectedToday)
  loadToday()
  renderServicesTable()
  renderEntriesAndExpenses() 
  if($('view-admin').style.display === 'block') { renderMonthlySummary(); renderFullExpenseHistory(); }
  if($('view-history').style.display === 'block') { loadHistory(); }
}

/* ============================ TODAY VIEW (SCHEDULES) ============================ */
function loadToday(){
  const today = todayStr()
  const schedulesToday = DATA.schedules.filter(s => s.date === today).sort((a,b) => a.time.localeCompare(b.time))
  $('todayLabel').innerText = formatDateBR(today)
  $('todayCount').innerText = `${schedulesToday.length} agendamentos`
  $('rushCount').innerText = schedulesToday.length
  $('pendingCount').innerText = schedulesToday.filter(s => !s.paid).length
  const tbody = $('tableToday').querySelector('tbody'); tbody.innerHTML = ''
  schedulesToday.forEach((s, i) => {
    const service = DATA.services.find(svc => svc.id === s.serviceId) || {name: 'Servi√ßo exclu√≠do', price: s.valor, time: s.tempo}
    const endTime = s.time ? addMinsToTime(s.time, s.tempo) : '--:--';
    const row = tbody.insertRow()
    row.insertCell().innerText = i + 1
    
    /* CORRE√á√ÉO 1: Adiciona a chamada de promptAdminPasswordForEdit ao clicar no nome do cliente */
    const clientCell = row.insertCell()
    clientCell.innerHTML = `<span class="client-name-clickable" onclick="promptAdminPasswordForEdit('${s.id}')">${s.name}</span>`
    
    let serviceText = (service.name || 'Servi√ßo')
    if (s.adds && s.adds.length > 0) {
        const addsNames = s.adds.map(addId => {
            const addSvc = DATA.services.find(a => a.id === addId);
            return addSvc ? addSvc.name : 'Adicional';
        });
        serviceText += ' + ' + addsNames.join(' + ');
    }
    
    let displayValor = money(s.valor);
    if (s.discountPercent && Number(s.discountPercent) > 0) {
        displayValor = `${money(s.valor)} <span style="font-size:10px;color:var(--muted)">(${s.discountPercent}% off)</span>`;
    }
    row.insertCell().innerHTML = serviceText
    const timeCell = row.insertCell(); timeCell.innerHTML = `<strong>${s.time || '--:--'}</strong> / <span style="color:var(--info)">${endTime}</span>`
    row.insertCell().innerHTML = `<strong>${displayValor}</strong>`
    
    let statusText = s.paid ? 'Pago' : 'Pendente';
    if (s.paid && s.paymentMethod) {
        statusText += ` (${s.paymentMethod.substring(0, 1).toUpperCase()})`; 
    }
    const statusCell = row.insertCell(); statusCell.className = s.paid ? 'paid' : 'not-paid'; statusCell.innerText = statusText
    const actionCell = row.insertCell(); actionCell.className = 'actions'
    
    if(!s.paid){
      const payBtn = document.createElement('button'); payBtn.className = 'btn btn-sm'; payBtn.innerHTML = '<i class="fa-solid fa-hand-holding-dollar"></i> Pagar'; payBtn.onclick = () => confirmPayment(s.id); actionCell.appendChild(payBtn)
    } else {
      const printBtn = document.createElement('button'); printBtn.className = 'btn ghost btn-sm'; printBtn.innerHTML = '<i class="fa-solid fa-receipt"></i> Nota'; printBtn.onclick = () => printCustomerQuote(s); actionCell.appendChild(printBtn)
    }
    const cancelBtn = document.createElement('button'); cancelBtn.className = 'btn ghost btn-sm'; cancelBtn.style.color = 'var(--danger)'; cancelBtn.style.borderColor = 'var(--danger)'; cancelBtn.innerHTML = '<i class="fa-solid fa-times"></i>'; cancelBtn.onclick = () => cancelSchedule(s.id); actionCell.appendChild(cancelBtn)
    
    const noteCell = row.insertCell(); noteCell.className = 'actions';
    const noteBtn = document.createElement('button'); 
    noteBtn.className = 'btn ghost btn-sm'; 
    noteBtn.innerHTML = '<i class="fa-solid fa-file-invoice-dollar"></i> Or√ßamento'; 
    noteBtn.onclick = () => printCustomerQuote(s, true); // True para for√ßar Or√ßamento
    noteCell.appendChild(noteBtn)
  })
}

/* =========== EDIT / MODAL =========== */
function saveScheduleEdit(e) {
    e.preventDefault();
    const scheduleId = $('editScheduleId').value;
    const schedule = DATA.schedules.find(s => s.id === scheduleId);
    if (!schedule) { alert('Erro: Agendamento n√£o encontrado.'); closeEditModal(); return; }
    
    const oldName = schedule.name; 
    const newName = $('editClientNameInput').value.trim();
    const newVehicle = $('editVehicle').value;
    const newDate = $('editDate').value;
    const newTime = $('editTime').value;
    const newServiceId = $('editService').value;
    const newAdds = Array.from(document.querySelectorAll('#editAdds input[type="checkbox"]:checked')).map(cb => cb.value);
    const newTempo = Number($('editTempoInput').value) || 0; 
    const newValor = Number($('editValor').value) || 0; 
    const newPaymentMethod = $('editPaymentMethod').value;
    const wasPaid = schedule.paid;
    const nowPaid = newPaymentMethod !== 'pendente';


    if (newValor <= 0) { alert('O valor do servi√ßo deve ser maior que zero.'); return; }
    
    const baseDetails = getServicePriceAndDuration(newServiceId, newAdds);
    const baseValor = baseDetails.valor;
    const newDiscount = baseValor > 0 ? (1 - (newValor / baseValor)) * 100 : 0;

    if (newDate >= todayStr() && isTimeSlotOccupied(newTime, newTempo, newDate, scheduleId)) { return; }

    if (oldName !== newName) {
        if (confirm(`O nome do cliente foi alterado de "${oldName}" para "${newName}". Deseja aplicar essa altera√ß√£o a TODOS os agendamentos anteriores de "${oldName}"?`)) {
            DATA.schedules.filter(s => s.name === oldName).forEach(s => s.name = newName);
        }
    }

    schedule.name = newName;
    schedule.vehicle = newVehicle;
    schedule.date = newDate;
    schedule.time = newTime;
    schedule.serviceId = newServiceId;
    schedule.adds = newAdds;
    schedule.tempo = newTempo;
    schedule.discountPercent = Math.round(newDiscount * 100) / 100;
    schedule.valor = newValor;
    
    const newPaidValue = nowPaid ? calculateValueWithFee(newValor, newPaymentMethod) : 0;

    // Gerenciamento da Entrada no Caixa
    DATA.entries = DATA.entries.filter(e => e.scheduleId !== scheduleId); 

    if (nowPaid) {
        const paymentDateISO = schedule.paidAt || new Date().toISOString();
        schedule.paid = true;
        schedule.paymentMethod = newPaymentMethod;
        schedule.paidValue = newPaidValue;
        schedule.paidAt = paymentDateISO;
        DATA.entries.push({ id: idGen(), label: `Agendamento [EDITADO] - ${newName} (${formatDateBR(newDate)})`, value: newPaidValue, time: paymentDateISO, scheduleId: scheduleId });
        alert(`Servi√ßo atualizado. Novo valor l√≠quido de ${money(newPaidValue)} registrado no caixa.`);
    } else {
        schedule.paid = false;
        schedule.paymentMethod = null;
        schedule.paidValue = 0;
        schedule.paidAt = null;
        if (wasPaid) {
            alert(`Servi√ßo atualizado para PENDENTE. O valor anterior foi estornado/removido do caixa.`);
        } else {
            alert(`Servi√ßo atualizado. Novo valor: ${money(newValor)}.`);
        }
    }
    
    save(); closeEditModal();
}

function editScheduleService(scheduleId) {
    const schedule = DATA.schedules.find(s => s.id === scheduleId); if (!schedule) return;
    $('editScheduleId').value = scheduleId;
    
    $('editClientNameInput').value = schedule.name;
    $('editVehicle').value = schedule.vehicle || 'moto'; 
    $('editDate').value = schedule.date;
    $('editTime').value = schedule.time || '';
    $('editValor').value = schedule.valor.toFixed(2); 
    $('editTempoInput').value = schedule.tempo;
    
    $('editPaymentMethod').value = schedule.paid ? (schedule.paymentMethod || 'dinheiro') : 'pendente';

    renderEditServiceOptions(schedule.vehicle, schedule.serviceId, schedule.adds || []);
    updateEditServiceDetails(true); 
    $('editServiceModal').style.display = 'flex';
}

// Fun√ß√µes auxiliares para o modal de edi√ß√£o
function renderEditServiceOptions(selectedVehicle = null, selectedServiceId = null, selectedAdds = []) {
    const vehicle = selectedVehicle || $('editVehicle').value;
    const mainServices = DATA.services.filter(s => s.isAdd===false && (s.category === vehicle || s.category === 'both'));
    const addServices = DATA.services.filter(s => s.isAdd===true && (s.category === vehicle || s.category === 'both'));
    const selectService = $('editService');
    selectService.innerHTML = mainServices.map(s => `<option value="${s.id}" data-price="${s.price}" data-time="${s.time}" ${s.id === selectedServiceId ? 'selected' : ''}>${s.name} (${money(s.price)})</option>`).join('');
    const inputAdds = $('editAdds');
    inputAdds.innerHTML = addServices.map(s => `<label class="small" style="display:flex;align-items:center;gap:5px;"><input type="checkbox" name="add-on" value="${s.id}" data-price="${s.price}" onchange="updateEditServiceDetails()" ${selectedAdds.includes(s.id) ? 'checked' : ''}>${s.name} (${money(s.price)})</label>`).join('');
    // Seleciona o servi√ßo principal ap√≥s carregar as op√ß√µes
    if(selectedServiceId) { $('editService').value = selectedServiceId; }
}

function updateEditServiceDetails(forceDurationUpdate = false) {
    const serviceId = $('editService').value;
    const adds = Array.from(document.querySelectorAll('#editAdds input[type="checkbox"]:checked')).map(cb => cb.value);
    const startTime = $('editTime').value;
    const details = getServicePriceAndDuration(serviceId, adds);
    
    let totalTime = Number($('editTempoInput').value) || details.tempo; // Mant√©m o valor manual, a menos que seja for√ßado
    if (!forceDurationUpdate) {
      $('editTempoInput').value = totalTime;
    } else {
      totalTime = Number($('editTempoInput').value) || 0;
    }

    if (startTime && totalTime > 0) {
        const endTime = addMinsToTime(startTime, totalTime);
        $('editEndTime').value = `${endTime} (${totalTime} min)`;
    } else {
        $('editEndTime').value = `--:-- (${totalTime} min)`;
    }
}

function closeEditModal(){ $('editServiceModal').style.display = 'none'; }


/* ============================ PAYMENT / CANCEL ============================ */
function confirmPayment(scheduleId){
  const schedule = DATA.schedules.find(s => s.id === scheduleId); if(!schedule) return;
  const method = prompt('Forma de Pagamento (digite um n√∫mero):\n1. Dinheiro\n2. PIX\n3. Cart√£o de D√©bito\n4. Cart√£o de Cr√©dito');
  let paymentMethod = 'dinheiro';
  if(method === '2') paymentMethod = 'pix';
  else if(method === '3') paymentMethod = 'debito';
  else if(method === '4') paymentMethod = 'credito';
  else if (method !== '1') { return; } // Cancela se n√£o for 1, 2, 3, 4, ou cancelar

  const netValue = calculateValueWithFee(schedule.valor, paymentMethod);
  const fee = schedule.valor - netValue;

  let msg = `Confirmar o pagamento de ${schedule.name} no valor de ${money(schedule.valor)} (${parsePaymentMethod(paymentMethod)})?`;
  if (fee > 0) {
      msg += `\nTaxa: ${money(fee)} - Valor l√≠quido no caixa: ${money(netValue)}.`;
  }
  if (schedule.date !== todayStr()) { msg += `\n\nATEN√á√ÉO: Este agendamento era do dia ${formatDateBR(schedule.date)}.`; }
  
  if(confirm(msg)){
    DATA.entries = DATA.entries.filter(e => e.scheduleId !== scheduleId); 
    schedule.paid = true;
    schedule.paymentMethod = paymentMethod; 
    schedule.paidValue = netValue; 
    schedule.paidAt = new Date().toISOString();

    DATA.entries.push({ id: idGen(), label: `Agendamento - ${schedule.name} (${formatDateBR(schedule.date)}) [${paymentMethod.toUpperCase()}]`, value: schedule.paidValue, time: schedule.paidAt, scheduleId: scheduleId })
    save()
    alert('Pagamento confirmado e registrado no caixa (valor l√≠quido) com sucesso!')
    if(confirm('Deseja imprimir a Nota/Comprovante agora (Otimizado para T√©rmica)?')){ printThermalNoteWrapper(schedule); }
  }
}

function togglePaymentStatus(scheduleId){
    const schedule = DATA.schedules.find(s => s.id === scheduleId); if(!schedule) return;
    if (schedule.paid) {
        if(confirm(`Tem certeza que deseja marcar o servi√ßo de ${schedule.name} como PENDENTE (Estornar ${money(schedule.paidValue)} do caixa)?`)){
            DATA.entries = DATA.entries.filter(e => e.scheduleId !== scheduleId);
            schedule.paid = false;
            schedule.paidAt = null; 
            schedule.paymentMethod = null;
            schedule.paidValue = 0;
            save();
            alert(`Status alterado para PENDENTE. Valor estornado do caixa.`);
        }
    } else {
        const method = prompt('Forma de Pagamento (digite um n√∫mero):\n1. Dinheiro\n2. PIX\n3. Cart√£o de D√©bito\n4. Cart√£o de Cr√©dito');
        let paymentMethod = 'dinheiro';
        if(method === '2') paymentMethod = 'pix';
        else if(method === '3') paymentMethod = 'debito';
        else if(method === '4') paymentMethod = 'credito';
        else if (method !== '1') { return; } 

        const netValue = calculateValueWithFee(schedule.valor, paymentMethod);
        const paidAt = new Date().toISOString();

        if(confirm(`Confirmar o pagamento (Mudar para PAGO) do servi√ßo de ${schedule.name} (${parsePaymentMethod(paymentMethod)}) no valor l√≠quido de ${money(netValue)}?`)){
            DATA.entries.push({ id: idGen(), label: `Agendamento - ${schedule.name} (${formatDateBR(schedule.date)}) [${paymentMethod.toUpperCase()}]`, value: netValue, time: paidAt, scheduleId: scheduleId });
            schedule.paid = true;
            schedule.paidAt = paidAt; 
            schedule.paymentMethod = paymentMethod;
            schedule.paidValue = netValue;
            save();
            alert(`Status alterado para PAGO. Valor l√≠quido (${money(netValue)}) adicionado ao caixa.`);
        }
    }
}

function cancelSchedule(id) {
    if(confirm('Tem certeza que deseja CANCELAR este agendamento? Ele ser√° removido permanentemente da agenda.')){
        const schedule = DATA.schedules.find(s => s.id === id);
        if (!schedule) return;
        if (schedule.paid) {
             DATA.entries = DATA.entries.filter(e => e.scheduleId !== id);
             alert(`Agendamento cancelado. A entrada de ${money(schedule.paidValue)} foi estornada/removida do caixa.`);
        } else {
             alert('Agendamento cancelado com sucesso.');
        }
        DATA.schedules = DATA.schedules.filter(s => s.id !== id);
        save();
    }
}

/* ============================ PRINT NOTE & QUOTE (PNG ENABLED) ============================ */
function downloadImageNote() {
    const element = $('noteContentToImage');
    const clientName = $('noteClientDetails').querySelector('strong').innerText.replace(/\s/g, '_').substring(0, 20);
    const dateStr = todayStr().replace(/-/g, '');
    
    // Altera temporariamente o padding para evitar corte na imagem (opcional, dependendo do design)
    const originalPadding = element.style.padding;
    element.style.padding = '30px'; 

    html2canvas(element, { 
        backgroundColor: '#ffffff',
        scale: 2 
    }).then(canvas => {
        // Volta o padding ao normal
        element.style.padding = originalPadding; 

        const imgData = canvas.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = imgData;
        a.download = `nota_${clientName}_${dateStr}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        alert('Imagem PNG da Nota/Comprovante baixada!');
    }).catch(error => {
        // Volta o padding ao normal em caso de erro
        element.style.padding = originalPadding; 
        console.error('Erro ao gerar PNG:', error);
        alert('Erro ao gerar a imagem da nota. Tente novamente ou use a impress√£o/copia.');
    });
}

let currentScheduleForPrint = null; // Vari√°vel para armazenar o agendamento atual

// Wrapper para impress√£o t√©rmica (usa a vari√°vel global)
function printThermalNoteWrapper(schedule = null) {
    if (schedule) {
        currentScheduleForPrint = schedule; // Se vier da confirma√ß√£o de pagamento
    }
    if (currentScheduleForPrint) {
        printThermalNote(currentScheduleForPrint);
    } else {
        alert('Erro: N√£o h√° agendamento para imprimir.');
    }
}

// CORRE√á√ÉO 2: Ajusta a impress√£o t√©rmica para n√£o mostrar taxas e destacar o Total.
function printThermalNote(s){
    if (!s) return;
    const service = DATA.services.find(svc => svc.id === s.serviceId) || {name: 'Servi√ßo', price: 0}
    const valorBase = (DATA.services.find(s=>s.id===s.serviceId)?.price || 0) + (s.adds||[]).reduce((acc,id)=> acc + ((DATA.services.find(s=>s.id===id)?.price)||0),0);
    const descontoAplicado = valorBase - s.valor;
    const isPaid = s.paid || false;
    const isQuote = !isPaid; // Se n√£o est√° pago, √© um or√ßamento

    let items = '';
    items += `${service.name.toUpperCase()}\n`;
    items += `  VALOR: ${money(service.price)}\n`;
    if(s.adds && s.adds.length){
        s.adds.forEach(addId => {
            const addSvc = DATA.services.find(s => s.id === addId);
            if (addSvc) { items += `  + ${addSvc.name} (+${money(addSvc.price)})\n`; }
        });
    }

    let paymentInfo = '';
    let title = isQuote ? 'OR√áAMENTO' : 'COMPROVANTE DE PAGAMENTO';
    if (isPaid) {
        paymentInfo += `FORMA PGTO: ${parsePaymentMethod(s.paymentMethod).toUpperCase()}\n`;
        // REMOVIDO: A parte que calculava e mostrava Taxa/Valor L√≠quido
        paymentInfo += `HORA PGTO: ${s.paidAt ? s.paidAt.substring(11, 16) : '--:--'}\n`;
    }

    // Logo em ASCII Art simples ou URL, mas o navegador tentar√° renderizar o CSS/HTML
    const logoHtml = DATA.brand.logo ? `<img src="${DATA.brand.logo}" style="width:50px; height:50px; display:block; margin: 0 auto; margin-bottom: 5px;">` : '';

    const noteContent = `
        <html>
        <head>
            <title>${title}</title>
            <style>
                @page { size: 80mm auto; margin: 0; }
                body { 
                    font-family: 'Consolas', monospace; 
                    font-size: 9pt; 
                    width: 80mm; 
                    padding: 5px; 
                    margin: 0;
                    color: #000;
                }
                .note-content { width: 100%; margin: 0 auto; }
                h3 { margin: 5px 0; font-size: 11pt; text-align: center; }
                p { margin: 2px 0; }
                .hr { border-top: 1px dashed #333; margin: 5px 0; }
                .total { 
                    font-size: 13pt; 
                    font-weight: bold; 
                    text-align: right; 
                    color: var(--accent); /* Cor Vermelha do seu tema (configurado no HTML) */
                }
                .status { font-weight: bold; text-align: center; margin-top: 5px;}
                /* Garante que o total fique vermelho/destacado mesmo no modo de impress√£o */
                .total-label { color: var(--accent); } 
            </style>
        </head>
        <body>
        <div class="note-content">
            ${logoHtml}
            <h3 style="text-align: center;">--- ${DATA.brand.name.toUpperCase()} ---</h3>
            <p style="text-align: center; font-size: 8pt;">${title} (N√ÉO FISCAL)</p>
            <div class="hr"></div>
            <p>CLIENTE: ${s.name}</p>
            <p>DATA AGEND: ${formatDateBR(s.date)} ${s.time ? `(${s.time})` : ''}</p>
            <p>TIPO VE√çC: ${s.vehicle ? s.vehicle.toUpperCase() : 'OUTROS'}</p>
            <div class="hr"></div>
            <p style="font-weight: bold;">SERVI√áOS:</p>
            <pre style="margin: 0; font-size: 8pt; white-space: pre-wrap;">${items}</pre>
            ${descontoAplicado > 0 ? `<p style="font-weight: bold; color: red;">DESCONTO (${s.discountPercent}%): - ${money(descontoAplicado)}</p>` : ''}
            <div class="hr"></div>
            ${isPaid ? `<p style="font-weight: bold;">INFO PAGAMENTO:</p><pre style="margin: 0; font-size: 8pt;">${paymentInfo}</pre><div class="hr"></div>` : ''}
            <p class="total"><span class="total-label">TOTAL:</span> ${money(s.valor)}</p>
            <div class="hr"></div>
            <p class="status" style="color: ${isPaid ? 'green' : 'red'};">STATUS: ${isPaid ? 'PAGO' : 'PENDENTE'}</p>
            <div class="hr"></div>
            <p style="text-align: center; font-size: 8pt; margin-top: 10px;">${isPaid ? 'AGRADECEMOS A PREFER√äNCIA!' : 'FA√áA SEU AGENDAMENTO.'}</p>
        </div>
        </body>
        </html>
    `;

    const printWindow = window.open('', '_blank', 'width=300,height=600');
    printWindow.document.write(noteContent);
    printWindow.document.close();
    printWindow.print();
}

function printCustomerQuote(schedule, forceQuote = false) {
    currentScheduleForPrint = schedule; // Armazena o agendamento para o wrapper de impress√£o t√©rmica

    const service = DATA.services.find(svc => svc.id === schedule.serviceId) || {name: 'Servi√ßo', price: 0}
    const isPaid = schedule.paid && !forceQuote; // Se for√ßar Or√ßamento, n√£o exibe como pago
    const isQuote = !isPaid;
    const baseValor = (DATA.services.find(s=>s.id===schedule.serviceId)?.price || 0) + (schedule.adds||[]).reduce((acc,id)=> acc + ((DATA.services.find(s=>s.id===id)?.price)||0),0);
    const descontoAplicado = baseValor - schedule.valor;
    const itemsHtml = [];
    const paymentInfoHtml = [];
    
    // Lista de Itens
    itemsHtml.push(`<div style="display:flex; justify-content:space-between; font-size:13px; font-weight:700; margin-bottom:3px;">
                        <span>${service.name}</span>
                        <span>${money(service.price)}</span>
                    </div>`);

    if(schedule.adds && schedule.adds.length){
        schedule.adds.forEach(addId => {
            const addSvc = DATA.services.find(s => s.id === addId);
            if (addSvc) {
                itemsHtml.push(`<div style="display:flex; justify-content:space-between; font-size:11px; margin-left:10px; color:var(--muted);">
                                    <span>+ ${addSvc.name}</span>
                                    <span>${money(addSvc.price)}</span>
                                </div>`);
            }
        });
    }

    if (descontoAplicado > 0) {
        itemsHtml.push(`<div style="display:flex; justify-content:space-between; font-size:12px; font-weight:700; color:var(--danger); margin-top:5px; border-top:1px dashed #ccc; padding-top:5px;">
                            <span>Desconto (${Math.round(schedule.discountPercent || 0)}%)</span>
                            <span>- ${money(descontoAplicado)}</span>
                        </div>`);
    }
    
    // Info Pagamento
    if (isPaid) {
        paymentInfoHtml.push(`<div style="margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 5px;">
            <p style="margin:0; font-weight:700;">STATUS: PAGO</p>
            <p style="margin:0;">Forma: ${parsePaymentMethod(schedule.paymentMethod)}</p>
            <p style="margin:0;">Hor√°rio: ${schedule.paidAt ? new Date(schedule.paidAt).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}) : '--:--'}</p>
        </div>`);
    } else {
        paymentInfoHtml.push(`<div style="margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 5px;">
            <p style="margin:0; font-weight:700; color:var(--danger);">STATUS: PENDENTE / OR√áAMENTO</p>
        </div>`);
    }

    $('noteTypeLabel').innerText = isQuote ? 'OR√áAMENTO (N√ÉO FISCAL)' : 'COMPROVANTE DE PAGAMENTO';
    $('noteClientDetails').innerHTML = `
        <p style="margin:0;">Cliente: <strong>${schedule.name}</strong></p>
        <p style="margin:0;">Agendado: ${formatDateBR(schedule.date)} ${schedule.time ? `√†s ${schedule.time}` : ''} (${schedule.tempo} min)</p>
        <p style="margin:0; font-weight:700; color:var(--info);">Total Base: ${money(baseValor)}</p>
    `;
    $('noteItemsList').innerHTML = itemsHtml.join('');
    $('notePaymentInfo').innerHTML = paymentInfoHtml.join('');
    $('noteFinalValue').innerText = money(schedule.valor);
    
    $('imageNoteContainer').style.display = 'flex';
}

/* ============================ NEW (SERVI√áOS E VALOR EDIT√ÅVEL) ============================ */
function getServicePriceAndDuration(serviceId, adds=[]){
  const mainService = DATA.services.find(s => s.id === serviceId)
  let totalValue = mainService ? mainService.price : 0
  let totalTime = mainService ? mainService.time : 0
  adds.forEach(addId => {
    const addService = DATA.services.find(s => s.id === addId)
    if(addService){ totalValue += addService.price; totalTime += addService.time }
  })
  return {valor: Number(totalValue.toFixed(2)), tempo: totalTime}
}

function renderServiceOptions(selectedVehicle = null, selectedServiceId = null, selectedAdds = []){
  const vehicle = selectedVehicle || $('inputVehicle').value
  const mainServices = DATA.services.filter(s => s.isAdd===false && (s.category === vehicle || s.category === 'both'))
  const addServices = DATA.services.filter(s => s.isAdd===true && (s.category === vehicle || s.category === 'both'))
  const selectService = $('inputService')
  selectService.innerHTML = mainServices.map(s => `<option value="${s.id}" data-price="${s.price}" data-time="${s.time}" ${s.id === selectedServiceId ? 'selected' : ''}>${s.name} (${money(s.price)})</option>`).join('')
  const inputAdds = $('inputAdds')
  inputAdds.innerHTML = addServices.map(s => `<label class="small" style="display:flex;align-items:center;gap:5px;"><input type="checkbox" name="add-on" value="${s.id}" data-price="${s.price}" onchange="updateTimeDetails()" ${selectedAdds.includes(s.id) ? 'checked' : ''}>${s.name} (${money(s.price)})</label>`).join('')
}

function updatePastDateWarning() {
    const date = $('inputDate').value; const today = todayStr(); const warning = $('pastDateWarning');
    const paymentOption = $('paymentOptionContainer');
    if (date < today) { 
        warning.style.display = 'flex'; 
        paymentOption.style.display = 'block';
        $('inputMarkPaid').checked = true; 
        togglePaymentDetails(true);
    } else { 
        warning.style.display = 'none'; 
        if (date > today) { paymentOption.style.display = 'none'; $('inputMarkPaid').checked = false; togglePaymentDetails(false); }
        else { paymentOption.style.display = 'block'; }
    }
}

function togglePaymentDetails(isPaid) {
    $('paymentDetails').style.display = isPaid ? 'grid' : 'none';
    if(isPaid) {
        calculateFinalValueWithFee(); 
    }
}

function showNameSuggestions(input) {
    const suggestionsDiv = $('nameSuggestions');
    if (input.length < 2) { suggestionsDiv.style.display = 'none'; return; }

    const uniqueNames = [...new Set(DATA.schedules.map(s => s.name))];
    const filteredNames = uniqueNames.filter(name => 
        name.toLowerCase().includes(input.toLowerCase())
    ).slice(0, 5);

    if (filteredNames.length === 0) { suggestionsDiv.style.display = 'none'; return; }

    suggestionsDiv.innerHTML = filteredNames.map(name => 
        `<div class="autocomplete-item" onclick="selectSuggestedName('${name}')">${name}</div>`
    ).join('');
    suggestionsDiv.style.display = 'block';
}

function selectSuggestedName(name) {
    $('inputName').value = name;
    $('nameSuggestions').style.display = 'none';
    loadClientHistory(name);
}


function loadClientHistory(clientName) {
    const container = $('clientHistoryContainer'); const list = $('clientHistoryList');
    if (clientName.length < 3) { container.style.display = 'none'; list.innerHTML = ''; return; }
    const normalizedName = clientName.toLowerCase().trim();
    const schedules = DATA.schedules.filter(s => s.name.toLowerCase().includes(normalizedName)).sort((a,b) => b.createdAt.localeCompare(a.createdAt)).slice(0,5);
    if (schedules.length === 0) { container.style.display = 'none'; list.innerHTML = ''; return; }
    list.innerHTML = schedules.map(s => {
        const service = DATA.services.find(svc => svc.id === s.serviceId) || { name: 'Servi√ßo Exclu√≠do' };
        const addsCount = s.adds ? s.adds.length : 0; const addsText = addsCount > 0 ? ` +${addsCount} adicional${addsCount > 1 ? 's' : ''}` : '';
        return `<div class="client-history-item" onclick="fillFormFromHistory('${s.id}')"><div class="service-name">${service.name}${addsText}</div><div class="details"><span>${formatDateBR(s.date)}</span><span>${s.time || '--:--'}</span><span style="color:var(--accent);">${money(s.valor)}</span></div></div>`;
    }).join('');
    container.style.display = 'block';
}

function fillFormFromHistory(scheduleId) {
    const s = DATA.schedules.find(s => s.id === scheduleId); if (!s) return;
    $('inputName').value = s.name; 
    $('inputVehicle').value = s.vehicle; 
    renderServiceOptions(s.vehicle, s.serviceId, s.adds); 
    $('inputDiscount').value = s.discountPercent || ''; 
    updateTimeDetails(); 
    alert(`üìã Campos de Servi√ßo e Tipo preenchidos com base no agendamento de ${formatDateBR(s.date)}. Por favor, confira Data e Hora.`);
}

function updateTimeDetails(){
    const serviceId = $('inputService').value; const adds = Array.from(document.querySelectorAll('#inputAdds input[type="checkbox"]:checked')).map(cb => cb.value); const startTime = $('inputTime').value;
    const details = getServicePriceAndDuration(serviceId, adds); const totalTime = details.tempo;
    const discount = Number($('inputDiscount').value) || 0; const finalValue = applyDiscount(details.valor, discount);
    
    $('inputTotalWithDiscount').value = finalValue.toFixed(2);
    
    if (startTime && totalTime > 0) { const endTime = addMinsToTime(startTime, totalTime); $('endTime').value = `${endTime} (${totalTime} min)`; } else { $('endTime').value = `--:-- (${totalTime} min)`; }
    
    updatePastDateWarning(); 
    calculateFinalValueWithFee(); 
}

function resetNewForm() {
    $('formNew').reset(); 
    $('inputDate').value = todayStr();
    $('inputVehicle').value = 'moto';
    renderServiceOptions(); 
    updateTimeDetails(); 
    $('clientHistoryContainer').style.display='none'; 
    $('clientHistoryList').innerHTML=''; 
    updatePastDateWarning();
    $('nameSuggestions').style.display = 'none'; 
    $('inputMarkPaid').checked = false;
    togglePaymentDetails(false); 
}


function createSchedule(e){
  e.preventDefault()
  const name = $('inputName').value.trim(); const vehicle = $('inputVehicle').value; const serviceId = $('inputService').value; const date = $('inputDate').value; const time = $('inputTime').value || '00:00'; const adds = Array.from(document.querySelectorAll('#inputAdds input[type="checkbox"]:checked')).map(cb => cb.value)
  const finalValue = Number($('inputTotalWithDiscount').value) || 0; 
  const markPaid = $('inputMarkPaid').checked;
  const paymentMethod = markPaid ? $('inputPaymentMethod').value : null;
  const paidValue = markPaid ? Number($('inputPaidValueWithFee').value) : 0;

  if(!serviceId){ alert('Selecione um servi√ßo principal.'); return }
  if(finalValue <= 0){ alert('O valor final deve ser maior que zero.'); return }
  
  const serviceDetails = getServicePriceAndDuration(serviceId, adds)
  const totalTime = serviceDetails.tempo;
  const baseValor = serviceDetails.valor;
  const discountPercent = baseValor > 0 ? (1 - (finalValue / baseValor)) * 100 : 0;
  
  if (date >= todayStr() && isTimeSlotOccupied(time, totalTime, date)) { 
    return; 
  }

  const newSchedule = { 
    id: idGen(), name, vehicle, serviceId, adds, date, time, 
    valor: finalValue, 
    tempo: totalTime, 
    discountPercent: Math.round(discountPercent * 100) / 100, 
    paid: markPaid, 
    paymentMethod: paymentMethod, 
    paidValue: paidValue,       
    paidAt: markPaid ? new Date().toISOString() : null, 
    createdAt: new Date().toISOString() 
  }
  
  DATA.schedules.push(newSchedule); 
  
  if(markPaid){
      const paymentDateISO = new Date().toISOString(); 
      DATA.entries.push({ id: idGen(), label: `Agendamento - ${name} (${formatDateBR(date)}) [${paymentMethod.toUpperCase()}]`, value: paidValue, time: paymentDateISO, scheduleId: newSchedule.id })
  }
  
  save()
  
  const msg = date < todayStr() 
    ? `‚úÖ Servi√ßo Hist√≥rico de ${name} (em ${formatDateBR(date)}) registrado. Valor l√≠quido: ${money(paidValue)}. Status: ${markPaid ? 'PAGO' : 'PENDENTE'}.`
    : `Agendamento para ${name} em ${formatDateBR(date)} √†s ${time} confirmado! Total: ${money(newSchedule.valor)}.`;
  
  alert(msg)
  
  resetNewForm();
}


/* ============================ CALENDAR VIEW ============================ */
function showDate(){
  const date = $('calendarDate').value; const search = $('searchClient').value.toLowerCase().trim()
  const schedulesDate = DATA.schedules.filter(s => s.date === date && s.name.toLowerCase().includes(search)).sort((a,b) => a.time.localeCompare(b.time))
  const tbody = $('tableCalendar').querySelector('tbody'); tbody.innerHTML = ''
  schedulesDate.forEach((s, i) => {
    const service = DATA.services.find(svc => svc.id === s.serviceId) || {name: 'Servi√ßo exclu√≠do'}
    const endTime = s.time ? addMinsToTime(s.time, s.tempo) : '--:--';
    const row = tbody.insertRow(); 
    row.insertCell().innerText = formatDateBR(s.date); 
    /* CORRE√á√ÉO 1: Adiciona a chamada de promptAdminPasswordForEdit ao clicar no nome do cliente */
    row.insertCell().innerHTML = `<span class="client-name-clickable" onclick="promptAdminPasswordForEdit('${s.id}')">${s.name}</span>`
    
    let serviceText = service.name; if (s.adds && s.adds.length>0){ const addsNames=s.adds.map(id=> (DATA.services.find(x=>x.id===id)?.name)||'Adicional'); serviceText += ' + ' + addsNames.join(' + '); }
    row.insertCell().innerText = serviceText
    const timeCell = row.insertCell(); timeCell.innerHTML = `<strong>${s.time || '--:--'}</strong> / <span style="color:var(--info)">${endTime}</span>`
    row.insertCell().innerText = money(s.valor)
    
    let statusText = s.paid ? 'Pago' : 'Pendente';
    if (s.paid && s.paymentMethod) {
        statusText += ` (${s.paymentMethod.substring(0, 1).toUpperCase()})`; 
    }
    const statusCell = row.insertCell(); statusCell.className = s.paid ? 'paid' : 'not-paid'; statusCell.innerText = statusText
    
    const actionCell = row.insertCell(); actionCell.className = 'actions'
    const cancelBtn = document.createElement('button'); cancelBtn.className = 'btn ghost btn-sm'; cancelBtn.style.color = 'var(--danger)'; cancelBtn.style.borderColor = 'var(--danger)'; cancelBtn.innerHTML = '<i class="fa-solid fa-times"></i> Cancelar'; cancelBtn.onclick = () => cancelSchedule(s.id); actionCell.appendChild(cancelBtn)
    
    const noteCell = row.insertCell(); noteCell.className = 'actions';
    const noteBtn = document.createElement('button'); 
    noteBtn.className = 'btn ghost btn-sm'; 
    noteBtn.innerHTML = '<i class="fa-solid fa-file-invoice-dollar"></i> Or√ßamento'; 
    noteBtn.onclick = () => printCustomerQuote(s, true); 
    noteCell.appendChild(noteBtn)
  })
}

/* ============================ HISTORY VIEW ============================ */
function loadHistory(){
  // O conte√∫do do hist√≥rico √© sempre vis√≠vel, mas a navega√ß√£o para a tela 'history' requer senha.
  const search = $('historySearchInput').value.toLowerCase().trim(); const statusFilter = $('historyStatusFilter').value;
  const filteredSchedules = DATA.schedules.filter(s => {
    const service = DATA.services.find(svc => svc.id === s.serviceId) || {name: 'Servi√ßo Exclu√≠do'};
    const nameMatch = s.name.toLowerCase().includes(search) || service.name.toLowerCase().includes(search);
    const statusMatch = (statusFilter === 'pago' && s.paid) || (statusFilter === 'pendente' && !s.paid) || (statusFilter === '');
    return nameMatch && statusMatch;
  });
  const sortedSchedules = filteredSchedules.sort((a,b) => b.createdAt.localeCompare(a.createdAt)).slice(0, 200);
  $('historyCountLabel').innerText = `Exibindo ${sortedSchedules.length} de ${filteredSchedules.length} agendamentos encontrados.`;
  const tbody = $('tableHistoryBody'); tbody.innerHTML = ''
  sortedSchedules.forEach((s) => {
    const service = DATA.services.find(svc => svc.id === s.serviceId) || {name: 'Servi√ßo exclu√≠do', price: s.valor, time: s.tempo}
    const endTime = s.time ? addMinsToTime(s.time, s.tempo) : '--:--';
    const row = tbody.insertRow()
    row.insertCell().innerText = formatDateBR(s.date)
    /* CORRE√á√ÉO 1: Adiciona a chamada de promptAdminPasswordForEdit ao clicar no nome do cliente */
    row.insertCell().innerHTML = `<span class="client-name-clickable" onclick="promptAdminPasswordForEdit('${s.id}')">${s.name}</span>`
    let serviceText = service.name
    if (s.adds && s.adds.length > 0) {
        const addsNames = s.adds.map(addId => { const addSvc = DATA.services.find(a => a.id === addId); return addSvc ? addSvc.name : 'Adicional'; });
        serviceText += ' + ' + addsNames.join(' + ');
    }
    row.insertCell().innerText = serviceText
    row.insertCell().innerHTML = `<strong>${s.time || '--:--'}</strong> / <span style="color:var(--info)">${endTime}</span>`
    row.insertCell().innerText = `${s.tempo} min`
    row.insertCell().innerText = money(s.valor)
    
    row.insertCell().innerText = s.paid ? parsePaymentMethod(s.paymentMethod) : '--';

    let statusText = s.paid ? 'Pago' : 'Pendente';
    const statusCell = row.insertCell(); statusCell.className = s.paid ? 'paid' : 'not-paid'; statusCell.innerText = statusText
    const actionCell = row.insertCell(); actionCell.className = 'actions'
    
    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'btn btn-sm';
    toggleBtn.style.backgroundColor = s.paid ? 'var(--danger)' : 'var(--success)';
    toggleBtn.style.color = 'white';
    toggleBtn.innerHTML = s.paid ? '<i class="fa-solid fa-rotate-left"></i> Pend.' : '<i class="fa-solid fa-check"></i> Pago';
    toggleBtn.onclick = () => togglePaymentStatus(s.id);
    actionCell.appendChild(toggleBtn);

    const cancelBtn = document.createElement('button'); 
    cancelBtn.className = 'btn ghost btn-sm'; 
    cancelBtn.style.color = 'var(--danger)'; 
    cancelBtn.style.borderColor = 'var(--danger)'; 
    cancelBtn.innerHTML = '<i class="fa-solid fa-times"></i>'; 
    cancelBtn.onclick = () => cancelSchedule(s.id); 
    actionCell.appendChild(cancelBtn);
    
    // NOVO: Adiciona a coluna e o bot√£o de Nota/Comprovante no Hist√≥rico
    const noteCell = row.insertCell(); 
    noteCell.className = 'actions';
    const noteBtn = document.createElement('button'); 
    noteBtn.className = 'btn ghost btn-sm'; 
    noteBtn.innerHTML = '<i class="fa-solid fa-receipt"></i> Nota'; 
    noteBtn.onclick = () => printCustomerQuote(s); // Abre a nota com o status real (pago ou pendente/or√ßamento)
    noteCell.appendChild(noteBtn);
  })
}

/* ============================ ADMIN / CONFIG ============================ */
function loadAdmin(){
  const balance = calculateBalance()
  $('initialCash').value = balance.initial.toFixed(2)
  $('brandNameInput').value = DATA.brand.name || ''
  $('adminPassInput').value = ''
  $('dashTotalEntries').innerText = money(balance.entries)
  $('dashTotalExpenses').innerText = money(balance.expenses)
  $('dashBalance').innerText = money(balance.balance)
  const todayBalance = calculateBalance(todayStr())
  $('adminTodayDate').innerText = formatDateBR(todayStr())
  $('dailyEntries').innerText = money(todayBalance.entries)
  $('dailyExpenses').innerText = money(todayBalance.expenses)
  $('dailyBalance').innerText = money(todayBalance.balance)
  
  $('feeDebito').value = DATA.fees.debito.toFixed(2);
  $('feeCredito').value = DATA.fees.credito.toFixed(2);
  
  renderMonthlySummary(); renderServicesTable(); renderEntriesAndExpenses(); renderFullExpenseHistory();
}

function saveFees(){
    const debito = Number($('feeDebito').value);
    const credito = Number($('feeCredito').value);

    if (isNaN(debito) || isNaN(credito) || debito < 0 || credito < 0 || debito > 100 || credito > 100) {
        alert('Taxas inv√°lidas. Use valores entre 0 e 100.');
        return;
    }

    DATA.fees.debito = debito;
    DATA.fees.credito = credito;
    save();
    alert('Taxas de d√©bito/cr√©dito salvas com sucesso!');
}

function saveConfig(){ 
    DATA.brand.name = $('brandNameInput').value; 
    const newPass = $('adminPassInput').value; 
    if(newPass){ DATA.adminPass = newPass } 
    
    const logoFile = $('logoFile').files[0]; 
    if(logoFile){ 
        const reader = new FileReader(); 
        reader.onload = function(e){ 
            DATA.brand.logo = e.target.result; 
            save(); 
            alert('Configura√ß√µes salvas (incluindo logo e/ou senha).') 
        }; 
        reader.readAsDataURL(logoFile) 
    } else { 
        save(); 
        alert('Configura√ß√µes salvas (exceto logo e/ou senha).') 
    } 
}


/* ============================ MOVIMENTOS (ENTRADAS/SA√çDAS) ============================ */
function renderEntriesAndExpenses(){
  const listEntries = $('listEntries'); 
  listEntries.innerHTML = DATA.entries.sort((a,b) => b.time.localeCompare(a.time)).slice(0, 10).map(e => `<div class="small" style="display:flex;justify-content:space-between;border-bottom:1px dashed #eee;padding:4px 0;"><span>${e.label.substring(0, 30)}...</span><span style="color:var(--success);font-weight:700;">+${money(e.value)}</span></div>`).join('')
}

function addExpense(){ 
  const desc = $('expDesc').value.trim(); const value = Number($('expValue').value); 
  if(!desc || isNaN(value) || value <= 0){ alert('Descreva a despesa e informe um valor v√°lido.'); return } 
  DATA.expenses.push({ id: idGen(), label: `Despesa - ${desc}`, value: value, time: new Date().toISOString() }); 
  save(); 
  $('expDesc').value = $('expValue').value = ''; 
  alert('Despesa registrada.') 
}

function renderFullExpenseHistory() {
    const tbody = $('expenseHistoryTable').querySelector('tbody'); tbody.innerHTML = '';
    const sortedExpenses = DATA.expenses.sort((a, b) => b.time.localeCompare(a.time));

    sortedExpenses.forEach(e => {
        const row = tbody.insertRow();
        row.id = `exp-${e.id}`;
        const dateCell = row.insertCell(); dateCell.innerText = formatDateBR(e.time.substring(0, 10)) + ' ' + e.time.substring(11, 16);
        const descCell = row.insertCell(); descCell.innerText = e.label.replace('Despesa - ', '');
        const valueCell = row.insertCell(); valueCell.innerText = money(e.value); valueCell.style.color = 'var(--danger)';
        const actionCell = row.insertCell(); actionCell.className = 'actions';

        const editBtn = document.createElement('button');
        editBtn.className = 'btn ghost btn-sm';
        editBtn.innerHTML = '<i class="fa-solid fa-pen-to-square"></i>';
        editBtn.onclick = () => enableExpenseEdit(e.id, row, descCell, valueCell);
        actionCell.appendChild(editBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn ghost btn-sm';
        deleteBtn.style.color = 'var(--danger)';
        deleteBtn.style.borderColor = 'var(--danger)';
        deleteBtn.innerHTML = '<i class="fa-solid fa-trash-can"></i>';
        deleteBtn.onclick = () => deleteExpense(e.id);
        actionCell.appendChild(deleteBtn);
    });
}

function openExpenseHistoryModal() { 
    // N√£o precisa de senha, pois j√° est√° no Admin
    renderFullExpenseHistory();
    $('expenseHistoryModal').style.display = 'flex'; 
}
function closeExpenseHistoryModal() { $('expenseHistoryModal').style.display = 'none'; renderEntriesAndExpenses(); refreshAll(); }
function enableExpenseEdit(id, row, descCell, valueCell) {
    if (row.classList.contains('edit-mode')) return;
    row.classList.add('edit-mode'); 
    const expense = DATA.expenses.find(exp => exp.id === id); if (!expense) return;
    const descInput = document.createElement('input'); descInput.type = 'text'; descInput.value = expense.label.replace('Despesa - ', '');
    descCell.innerHTML = ''; descCell.appendChild(descInput);
    const valueInput = document.createElement('input'); valueInput.type = 'number'; valueInput.step = '0.01'; valueInput.min = '0'; valueInput.value = expense.value.toFixed(2);
    valueCell.innerHTML = ''; valueCell.appendChild(valueInput);
    const actionCell = row.cells[3]; actionCell.innerHTML = '';
    const saveBtn = document.createElement('button'); saveBtn.className = 'btn btn-sm'; saveBtn.innerHTML = '<i class="fa-solid fa-save"></i>'; 
    saveBtn.onclick = () => saveExpenseEdit(id, descInput.value, valueInput.value); actionCell.appendChild(saveBtn);
    const cancelBtn = document.createElement('button'); cancelBtn.className = 'btn ghost btn-sm'; cancelBtn.innerHTML = '<i class="fa-solid fa-times"></i>'; 
    cancelBtn.onclick = () => renderFullExpenseHistory(); actionCell.appendChild(cancelBtn);
    descInput.focus();
}
function saveExpenseEdit(id, newDesc, newValue) {
    const expense = DATA.expenses.find(exp => exp.id === id); if (!expense) return;
    const value = Number(newValue);
    if (!newDesc.trim() || isNaN(value) || value <= 0) {
        alert('Descri√ß√£o e valor da despesa devem ser v√°lidos.');
        renderFullExpenseHistory();
        return;
    }
    expense.label = `Despesa - ${newDesc.trim()}`;
    expense.value = value;
    save();
    renderFullExpenseHistory();
    alert('Despesa atualizada com sucesso.');
}
function deleteExpense(id) {
    if(confirm('Tem certeza que deseja APAGAR esta despesa?')){
        DATA.expenses = DATA.expenses.filter(e => e.id !== id);
        save();
        renderFullExpenseHistory();
        alert('Despesa apagada com sucesso.');
    }
}

/* ============================ INICIALIZA√á√ÉO ============================ */
document.addEventListener('DOMContentLoaded', () => {
    renderBrand(); updateClock(); refreshAll();
    $('calendarDate').value = todayStr(); 
    $('inputDate').value = todayStr();
    renderServiceOptions(); 
    updateTimeDetails(); 

    document.querySelectorAll('#inputService, #inputTime, #inputDate, #inputDiscount, #inputVehicle').forEach(el => el.addEventListener('change', updateTimeDetails));
    document.querySelectorAll('#inputAdds').forEach(el => el.addEventListener('change', updateTimeDetails));
    
    $('inputTotalWithDiscount').addEventListener('input', calculateFinalValueWithFee);
    
});


/* ================== Fun√ß√µes do HTML que n√£o foram alteradas mas s√£o necess√°rias ================== */
function renderMonthlySummary() {
  const summary = calculateMonthlySummary(); const tbody = $('monthlySummaryTable').querySelector('tbody'); tbody.innerHTML = ''; const today = new Date(); $('monthlyLabel').innerText = today.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
  let totalEntradas = 0; let totalSaidas = 0;
  const sortedSummary = Object.values(summary).sort((a, b) => a.dateStr.localeCompare(b.dateStr));
  sortedSummary.forEach(item => {
    const row = tbody.insertRow();
    const date = new Date(item.dateStr + 'T12:00:00'); const dayName = date.toLocaleDateString('pt-BR', { weekday: 'short' });
    row.insertCell().innerText = dayName; row.insertCell().innerText = formatDateBR(item.dateStr);
    row.insertCell().innerText = money(item.entries); totalEntradas += item.entries;
    row.insertCell().innerText = money(item.expenses).replace('R$ -', '-R$ '); totalSaidas += item.expenses;
    const balanceCell = row.insertCell(); balanceCell.innerText = money(item.balance); balanceCell.style.color = item.balance >= 0 ? 'var(--success)' : 'var(--danger)';
  });
  const totalRow = tbody.insertRow(); totalRow.style.backgroundColor = 'var(--line)';
  totalRow.insertCell().innerHTML = `<strong>TOTAL</strong>`; totalRow.insertCell().innerHTML = `<strong>${today.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' })}</strong>`;
  totalRow.insertCell().innerHTML = `<strong>${money(totalEntradas)}</strong>`; totalRow.insertCell().innerHTML = `<strong>${money(totalSaidas)}</strong>`;
  const totalBalance = totalEntradas - totalSaidas; const totalBalanceCell = totalRow.insertCell(); totalBalanceCell.innerHTML = `<strong>${money(totalBalance)}</strong>`; totalBalanceCell.style.color = totalBalance >= 0 ? 'var(--success)' : 'var(--danger)';
}
function setInitialCash(){ const newCash = Number($('initialCash').value); if(isNaN(newCash) || newCash < 0){ alert('Valor inv√°lido.'); return } DATA.initialCash = newCash; save(); alert(`Saldo inicial definido para ${money(newCash)}.`) }
function resetConfig(){ if(confirm('Tem certeza que deseja apagar TODOS os dados (agendamentos, caixa, servi√ßos)? Esta a√ß√£o √© irrevers√≠vel!')){ localStorage.removeItem(KEY); DATA = JSON.parse(JSON.stringify(DEFAULT)); save(); alert('Todos os dados foram resetados.'); location.reload() } }
function clearAllData(keepSchedules = false){ let message = 'ATEN√á√ÉO: Deseja zerar todo o fluxo de caixa (Saldo Inicial, Entradas e Despesas)?'; if (keepSchedules) { message += '\n\nOs AGENDAMENTOS ser√£o MANTIDOS (mas ter√£o o status de PENDENTE para o novo ciclo de caixa).'; } else { message += '\n\nOs AGENDAMENTOS tamb√©m ser√£o APAGADOS.' } if(confirm(message)){ DATA.initialCash = 0; DATA.entries = []; DATA.expenses = []; if(!keepSchedules){ DATA.schedules = []; } else { DATA.schedules.forEach(s => s.paid = false); } save(); alert('Fluxo de caixa zerado com sucesso!'); loadAdmin(); } }
function clearToday(){ if(confirm('Tem certeza que deseja limpar a lista de agendamentos de HOJE? Somente agendamentos de hoje ser√£o removidos.')){ const today = todayStr(); DATA.schedules = DATA.schedules.filter(s => s.date !== today); save(); alert('Agendamentos de hoje limpos.') } }
function renderServicesTable(){ const tbody = $('servicesTable').querySelector('tbody'); tbody.innerHTML = ''; DATA.services.forEach(s => { const row = tbody.insertRow(); row.id = `svc-${s.id}`; const nameCell = row.insertCell(); nameCell.innerText = s.name; nameCell.onclick = () => enableEdit(row, s.id, 'name', nameCell, 'text', s.name)
  const catCell = row.insertCell(); catCell.innerText = s.category === 'moto' ? 'Moto' : s.category === 'carro' ? 'Carro' : s.category === 'outros' ? 'Outros' : 'Ambos'; 
  const catOptions = [{value:'both', text:'Ambos'}, {value:'moto', text:'Moto'}, {value:'carro', text:'Carro'}, {value:'outros', text:'Outros'}];
  catCell.onclick = () => enableEdit(row, s.id, 'category', catCell, 'select', s.category, catOptions)
  const isAddCell = row.insertCell(); isAddCell.innerText = s.isAdd ? 'Adicional' : 'Principal'; isAddCell.onclick = () => enableEdit(row, s.id, 'isAdd', isAddCell, 'select', s.isAdd.toString(), [{value:'false', text:'Principal'}, {value:'true', text:'Adicional'}])
  const priceCell = row.insertCell(); priceCell.innerText = money(s.price); priceCell.onclick = () => enableEdit(row, s.id, 'price', priceCell, 'number', s.price.toFixed(2), null, '0.01')
  const timeCell = row.insertCell(); timeCell.innerText = `${s.time} min`; timeCell.onclick = () => enableEdit(row, s.id, 'time', timeCell, 'number', s.time)
  const actionCell = row.insertCell(); actionCell.className = 'actions'
  const delBtn = document.createElement('button'); delBtn.className = 'btn ghost btn-sm'; delBtn.style.color = 'var(--danger)'; delBtn.style.borderColor = 'var(--danger)'; delBtn.innerHTML = '<i class="fa-solid fa-trash-can"></i> Apagar'; delBtn.onclick = () => deleteService(s.id); actionCell.appendChild(delBtn)
}) }
function enableEdit(row, id, field, cell, type, currentValue, options = null, step = '1') {
    if (row.classList.contains('edit-mode')) return;
    row.classList.add('edit-mode'); cell.innerHTML = '';
    let input;
    if (type === 'select' && options) { input = document.createElement('select'); options.forEach(opt => { const option = document.createElement('option'); option.value = opt.value; option.text = opt.text; if (opt.value.toString() === currentValue.toString()) option.selected = true; input.appendChild(option); }); }
    else { input = document.createElement('input'); input.type = type; input.value = currentValue; if (type === 'number') { input.min = '0'; input.step = step; } }
    cell.appendChild(input);
    const actionCell = row.cells[5]; actionCell.innerHTML = '';
    const saveBtn = document.createElement('button'); saveBtn.className = 'btn btn-sm'; saveBtn.innerHTML = '<i class="fa-solid fa-save"></i>'; saveBtn.onclick = () => saveEdit(id, field, input.value, row); actionCell.appendChild(saveBtn);
    const cancelBtn = document.createElement('button'); cancelBtn.className = 'btn ghost btn-sm'; cancelBtn.innerHTML = '<i class="fa-solid fa-times"></i>'; cancelBtn.onclick = () => renderServicesTable(); actionCell.appendChild(cancelBtn);
    input.focus();
}

function saveEdit(id, field, newValue, row) {
    const service = DATA.services.find(s => s.id === id); if (!service) return;
    if (field === 'price' || field === 'time') { newValue = Number(newValue); if (isNaN(newValue) || newValue < 0) { alert(`Valor inv√°lido para ${field}.`); renderServicesTable(); return; } } else if (field === 'isAdd') { newValue = newValue === 'true'; } else if (field === 'name' && !newValue.trim()) { alert('O nome do servi√ßo n√£o pode ser vazio.'); renderServicesTable(); return; }
    service[field] = newValue;
    if(field === 'price' || field === 'time'){ 
        DATA.schedules.filter(s => s.serviceId === id && !s.paid).forEach(s => { 
            const details = getServicePriceAndDuration(s.serviceId, s.adds); 
            const newValor = applyDiscount(details.valor, s.discountPercent || 0); 
            s.valor = newValor;
            s.tempo = details.tempo; 
        }); 
    }
    save(); renderServicesTable();
}

function addService(){ const name = $('svcName').value.trim(); const category = $('svcCategory').value; const isAdd = $('svcIsAdd').value === 'true'; const price = Number($('svcPrice').value); const time = Number($('svcTime').value); if(!name || isNaN(price) || price < 0 || isNaN(time) || time < 0){ alert('Preencha todos os campos corretamente.'); return } DATA.services.push({ id: idGen(), name, category, isAdd, price, time }); save(); $('svcName').value = $('svcPrice').value = $('svcTime').value = ''; alert('Servi√ßo adicionado.') }

function deleteService(id){ const today = todayStr(); const futureSchedules = DATA.schedules.filter(s => s.serviceId === id && s.date >= today); let confirmationMessage = 'Tem certeza que deseja excluir este servi√ßo? '; if (futureSchedules.length > 0) { confirmationMessage += `\n\nATEN√á√ÉO: Existem ${futureSchedules.length} agendamentos futuros usando este servi√ßo! Excluir pode comprometer o hist√≥rico.`; } else { confirmationMessage += 'Esta a√ß√£o √© irrevers√≠vel.' } if(confirm(confirmationMessage)){ DATA.services = DATA.services.filter(s => s.id !== id); save(); alert('Servi√ßo exclu√≠do.') } }

function downloadJson(){ const dataStr = JSON.stringify(DATA, null, 2); const blob = new Blob([dataStr], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `wap_vupt_backup_${todayStr()}.json`; a.click(); URL.revokeObjectURL(url); alert('Backup (JSON) baixado. Guarde em um local seguro.') }
function exportData(){ let csvContent = 'Data;Cliente;Servico;Valor;Pago;Data_Completa\n'; DATA.schedules.forEach(s => { const service = DATA.services.find(svc => svc.id === s.serviceId) || {name: 'Servi√ßo Excluido'}; csvContent += `${formatDateBR(s.date)};${s.name};"${service.name}";${s.valor.toFixed(2).replace('.',',')};${s.paid ? 'Sim' : 'N√£o'};${s.createdAt}\n` }); const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `wap_vupt_export_${todayStr()}.csv`; a.click(); URL.revokeObjectURL(url); alert('Dados exportados (CSV) com sucesso.') }
function printToday(){ const content = document.querySelector('#tableToday').outerHTML; const today = todayStr(); const printWindow = window.open('', '_blank', 'width=800,height=600'); printWindow.document.write(`<html><head><title>Agenda ${formatDateBR(today)}</title><style>table{width:100%;border-collapse:collapse;margin-top:20px}th,td{padding:8px;border:1px solid #ccc;text-align:left;font-size:12px}th{background:#f0f0f0}.paid{color:green} .not-paid{color:red}</style></head><body><h2>Agenda de Agendamentos - ${formatDateBR(today)}</h2>${content}</body></html>`); printWindow.document.close(); printWindow.print(); }

</script>
</body>
</html>