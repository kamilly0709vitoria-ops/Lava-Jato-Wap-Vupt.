<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wap Vupt — Agendamentos & Controle Financeiro</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
  /* DESIGN SOFISTICADO E MODERNO */
  :root{
    --bg: #f7f9fc;
    --panel: #ffffff;
    --muted: #6c757d;
    --accent: #b71c1c; /* VERMELHO: O que você usa no seu tema */
    --dark: #212529; /* PRETO/CINZA ESCURO: Cor principal */
    --line: #e3e8f0; /* CINZA CLARO: Linhas e bordas */
    --shadow: 0 4px 12px rgba(0,0,0,0.05);
    --success: #28a745;
    --danger: #dc3545;
    --info: #1565c0;
    --warning-bg: #fff3cd;
    --warning-text: #856404;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:'Inter', 'Segoe UI', Roboto, Arial, sans-serif;color:var(--dark);background:var(--bg);}

  .layout{display:flex;min-height:100vh}
  aside{width:80px;background:var(--dark);color:#fff;padding:18px 0;display:flex;flex-direction:column;align-items:center;gap:16px;box-shadow:2px 0 5px rgba(0,0,0,0.1);}
  aside img.logo{width:50px;height:50px;border-radius:10px;object-fit:cover;border:2px solid rgba(255,255,255,0.1)}
  aside .nav-btn{width:100%;background:transparent;border:0;color:#ccc;padding:12px 0;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px;font-size:11px;transition:all 0.2s}
  aside .nav-btn:hover{background:rgba(255,255,255,0.05);color:#fff}
  aside .nav-btn.active{background:var(--accent);color:#fff;box-shadow:inset 3px 0 0 #fff;font-weight:700}
  main{flex:1;padding:25px;display:flex;flex-direction:column;gap:20px}
  header.top{display:flex;align-items:center;justify-content:space-between;gap:20px;padding-bottom:10px;border-bottom:1px solid var(--line)}
  .brand{display:flex;align-items:center;gap:12px}
  .brand h1{margin:0;font-size:24px;font-weight:800;letter-spacing:-0.5px}
  .brand .subtitle{font-size:14px;color:var(--muted)}
  .card{background:var(--panel);border-radius:12px;padding:20px;box-shadow:var(--shadow);border:1px solid var(--line)}
  .grid{display:grid;gap:15px}
  .row{display:flex;gap:15px;align-items:center}
  .col{flex:1}
  .muted{color:var(--muted);font-size:14px}
  .small{font-size:12px;color:var(--muted)}

  table{width:100%;border-collapse:collapse;margin-top:15px}
  th,td{padding:12px 8px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
  th{font-size:13px;color:var(--dark);background:var(--line);font-weight:700;text-transform:uppercase}
  tr:last-child td{border-bottom:none}
  .paid{color:var(--success);font-weight:700}
  .not-paid{color:var(--danger);font-weight:700}

  input[type=text], input[type=time], input[type=date], input[type=number], select, textarea{
    width:100%;padding:12px;border-radius:8px;border:1px solid var(--line);background:var(--panel);font-size:14px;transition:border-color 0.2s
  }
  input:focus, select:focus, textarea:focus { border-color: var(--accent); outline: none; }
  button.btn{background:var(--accent);color:#fff;padding:10px 18px;border-radius:8px;border:0;cursor:pointer;font-weight:700;transition:all 0.2s}
  button.btn:hover{background:#9e0000}
  button.ghost{background:transparent;border:1px solid var(--line);color:var(--dark);padding:10px 18px;border-radius:8px;transition:all 0.2s}
  button.ghost:hover{background:var(--line)}
  .btn-sm { padding: 6px 10px; font-size: 12px; }
  .actions{display:flex;gap:10px}
  .controls{display:flex;gap:10px;align-items:center}
  footer{margin-top:20px;color:var(--muted);font-size:12px;text-align:center}

  .finance-grid-main { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
  .finance-stat-card { padding: 20px; border-radius: 10px; background: var(--panel); box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 5px solid; }
  .finance-stat-card.in { border-left-color: var(--success); } .finance-stat-card.out { border-left-color: var(--danger); } .finance-stat-card.bal { border-left-color: var(--info); }
  .finance-stat-card .label { font-size: 14px; color: var(--muted); margin-bottom: 5px; } .finance-stat-card .value { font-size: 28px; font-weight: 800; color: var(--dark); }
  .daily-summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; background: #f0f4f8; border-radius: 8px; border: 1px solid var(--line); margin-bottom: 20px; }
  .daily-stat { padding: 10px; background: var(--panel); border-radius: 6px; border: 1px solid #ddd; }
  .daily-stat .label { font-size: 11px; color: var(--muted); } .daily-stat .value { font-size: 18px; font-weight: 700; margin-top: 2px; }

  #monthlySummaryTable tbody td:nth-child(3) { color: var(--success); font-weight: 700; }
  #monthlySummaryTable tbody td:nth-child(4) { color: var(--danger); font-weight: 700; }
  #monthlySummaryTable tbody td:nth-child(5) { font-weight: 800; }

  #cash-info-today { display: none; }

  .edit-mode input, .edit-mode select { padding: 4px; font-size: 13px; margin: -4px 0; border: 1px solid var(--accent); }

  .client-history-item { padding: 8px; margin-bottom: 5px; border-radius: 4px; background: #f0f8ff; border: 1px solid var(--line); cursor: pointer; transition: background 0.2s; }
  .client-history-item:hover { background: #e6f7ff; }
  .client-history-item .service-name { font-weight: 700; color: var(--dark); font-size: 14px; }
  .client-history-item .details { font-size: 11px; color: var(--muted); margin-top: 2px; display: flex; justify-content: space-between; }

  .client-name-clickable { font-weight: 700; cursor: pointer; color: var(--dark); transition: color 0.2s; }
  .client-name-clickable:hover { color: var(--accent); text-decoration: underline; }

  .past-date-alert { margin-top: 10px; padding: 8px; border-radius: 6px; background-color: var(--warning-bg); color: var(--warning-text); font-weight: 700; font-size: 13px; display: flex; align-items: center; gap: 8px; border: 1px solid #ffeeba; }

  @media (max-width:880px){ aside{width:60px} .brand h1{font-size:20px} .finance-grid-main, .daily-summary { grid-template-columns: 1fr; } }
</style>
</head>
<body>
<div class="layout">
  <aside>
    <img id="sideLogo" class="logo" src="" style="display:none" alt="Logo">
    <button class="nav-btn active" data-view="today" title="Agendamentos" onclick="nav(this)"><i class="fa-solid fa-calendar-days"></i><div style="font-size:11px">Hoje</div></button>
    <button class="nav-btn" data-view="new" title="Novo" onclick="nav(this)"><i class="fa-solid fa-plus"></i><div style="font-size:11px">Novo</div></button>
    <button class="nav-btn" data-view="past-service" title="Serviço Passado" onclick="nav(this)"><i class="fa-solid fa-clock-rotate-left"></i><div style="font-size:11px">Histórico</div></button>
    <button class="nav-btn" data-view="calendar" title="Calendário" onclick="nav(this)"><i class="fa-solid fa-calendar"></i><div style="font-size:11px">Agenda</div></button>
    <button class="nav-btn" data-view="history" title="Histórico" onclick="nav(this)"><i class="fa-solid fa-list-ul"></i><div style="font-size:11px">Histórico</div></button>
    <button class="nav-btn" data-view="admin" title="Admin" onclick="nav(this)"><i class="fa-solid fa-gauge-high"></i><div style="font-size:11px">Admin</div></button>
    <div style="flex:1"></div>
    <div style="font-size:10px;color:#bbb">Wap Vupt </div>
  </aside>

  <main>
    <header class="top">
      <div class="brand">
        <h1 id="titleApp">Wap Vupt </h1>
        <div class="subtitle muted">Agendamentos • Caixa • Controle</div>
      </div>
      <div class="controls">
        <div class="small muted" id="clock">--:--</div>
        <button class="btn ghost btn-sm" onclick="exportData()"><i class="fa-solid fa-file-export"></i> Exportar</button>
        <button class="btn btn-sm" onclick="downloadJson()"><i class="fa-solid fa-database"></i> Backup</button>
      </div>
    </header>

    <section id="view-today" class="card" style="padding:15px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
        <div>
          <div class="muted">Agendamentos de</div>
          <div style="font-weight:800;font-size:20px" id="todayLabel"></div>
          <div class="muted small" id="todayCount">0 agendamentos</div>
        </div>
        <div class="card" style="padding:15px;width:300px">
          <h4>Fila de Hoje</h4>
          <div style="display:flex;flex-direction:column;gap:10px">
            <div class="row"><div style="flex:1">Total agendamentos</div><div id="rushCount" style="font-weight:700">0</div></div>
            <div class="row"><div style="flex:1">Pendentes de pagamento</div><div id="pendingCount" style="color:var(--danger);font-weight:700">0</div></div>
            <div class="row"><div style="flex:1">Recebido hoje</div><div id="collectedToday" style="font-weight:800;color:var(--success)">R$ 0,00</div></div>
          </div>
          <div style="margin-top:20px" class="row">
            <button class="btn ghost btn-sm" onclick="printToday()"><i class="fa-solid fa-print"></i> Imprimir</button>
            <button class="btn ghost btn-sm" onclick="clearToday()">Limpar Dia</button>
          </div>
        </div>
      </div>

      <div style="margin-top:15px">
        <table id="tableToday">
          <thead><tr><th>#</th><th>Cliente</th><th>Serviço</th><th>Hora (Início / Saída)</th><th>Valor</th><th>Status</th><th>Ações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="view-new" class="card" style="display:none">
      <h3>Novo Agendamento</h3>
      <form id="formNew" onsubmit="createSchedule(event)">
        <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:15px">
          <div>
            <label class="muted small">Nome do cliente</label>
            <input type="text" id="inputName" required oninput="loadClientHistory(this.value)">
          </div>
          <div>
            <label class="muted small">Veículo</label>
            <select id="inputVehicle" onchange="renderServiceOptions(); updateTimeDetails();">
              <option value="moto">Moto</option>
              <option value="carro">Carro</option>
            </select>
          </div>
          <div>
            <label class="muted small">Data</label>
            <input type="date" id="inputDate" min="2024-01-01" max="2028-12-31" required onchange="updateTimeDetails()">
          </div>
          <div>
            <label class="muted small">Serviço principal</label>
            <select id="inputService" required onchange="updateTimeDetails()"></select>
          </div>
          <div>
            <label class="muted small">Hora de início</label>
            <input type="time" id="inputTime" required onchange="updateTimeDetails()">
          </div>
          <div>
             <label class="muted small">Previsão de Saída</label>
             <input type="text" id="endTime" readonly style="background:#f9f9f9;font-weight:700;color:var(--info);" value="--:--">
          </div>
        </div>

        <div id="clientHistoryContainer" style="margin-top:15px; border:1px solid var(--line); padding:10px; border-radius:8px; display:none;">
            <label class="muted small">Agendamentos Passados</label>
            <div id="clientHistoryList" style="max-height:150px; overflow-y:auto; padding-right: 5px;"></div>
            <div class="muted small" style="margin-top:5px; text-align:right;">Clique para preencher campos.</div>
        </div>

        <div style="margin-top:20px">
          <label class="muted small">Adicionais</label>
          <div id="inputAdds" style="display:flex;flex-wrap:wrap;gap:15px;border:1px solid var(--line);padding:10px;border-radius:8px;"></div>
        </div>

        <div style="margin-top:12px; display:flex; gap:10px; align-items:center;">
          <div style="flex:1">
            <label class="muted small">Desconto (%) <span class="small muted">(opcional)</span></label>
            <input type="number" id="inputDiscount" min="0" max="100" placeholder="Ex: 10" onchange="updateTimeDetails()">
          </div>
          <div style="width:260px">
            <label class="muted small">Valor Total (com desconto)</label>
            <input type="text" id="inputTotalWithDiscount" readonly style="background:#f9f9f9;font-weight:800;color:var(--accent);">
          </div>
        </div>

        <div style="margin-top:20px" class="row">
          <button class="btn" type="submit"><i class="fa-solid fa-calendar-check"></i> Confirmar agendamento</button>
          <button class="btn ghost" type="button" onclick="document.getElementById('formNew').reset(); renderServiceOptions(); updateTimeDetails()">Limpar</button>
        </div>
      </form>
    </section>

    <section id="view-past-service" class="card" style="display:none">
        <h3>Registrar Serviço Realizado (Agendamento Passado)</h3>
        <p class="muted">Use este formulário para registrar um serviço que foi realizado em uma data anterior ou que não foi agendado previamente.</p>
        <form id="formPastService" onsubmit="createPastSchedule(event)">
            <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:15px">
                <div>
                    <label class="muted small">Data do Serviço Realizado</label>
                    <input type="date" id="inputPastDate" min="2024-01-01" max="2028-12-31" required onchange="updatePastDateWarning(); updatePastTimeDetails();">
                    <div id="pastDateWarning" class="past-date-alert" style="display:none;">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                        Data anterior! Registrando como **Agendamento Passado**.
                    </div>
                </div>
                <div>
                    <label class="muted small">Nome do cliente</label>
                    <input type="text" id="inputPastName" required oninput="loadClientHistory(this.value)">
                </div>
                <div>
                    <label class="muted small">Veículo</label>
                    <select id="inputPastVehicle" onchange="renderPastServiceOptions(); updatePastTimeDetails();">
                        <option value="moto">Moto</option>
                        <option value="carro">Carro</option>
                    </select>
                </div>
                <div>
                    <label class="muted small">Serviço principal</label>
                    <select id="inputPastService" required onchange="updatePastTimeDetails()"></select>
                </div>
                <div>
                    <label class="muted small">Hora de início (Aprox.)</label>
                    <input type="time" id="inputPastTime" onchange="updatePastTimeDetails()">
                </div>
                <div>
                    <label class="muted small">Tempo/Previsão</label>
                    <input type="text" id="pastEndTime" readonly style="background:#f9f9f9;font-weight:700;color:var(--info);" value="--:--">
                </div>
            </div>

            <div style="margin-top:20px">
                <label class="muted small">Adicionais</label>
                <div id="inputPastAdds" style="display:flex;flex-wrap:wrap;gap:15px;border:1px solid var(--line);padding:10px;border-radius:8px;"></div>
            </div>

            <div style="margin-top:12px; display:flex; gap:10px; align-items:center;">
              <div style="flex:1">
                <label class="muted small">Desconto (%) <span class="small muted">(opcional)</span></label>
                <input type="number" id="inputPastDiscount" min="0" max="100" placeholder="Ex: 10" onchange="updatePastTimeDetails()">
              </div>
              <div style="width:260px">
                <label class="muted small">Valor Total (com desconto)</label>
                <input type="text" id="inputPastTotalWithDiscount" readonly style="background:#f9f9f9;font-weight:800;color:var(--accent);">
              </div>
            </div>

            <div style="margin-top:12px; display:flex; align-items:center; gap:8px;">
                <input type="checkbox" id="inputPastMarkPaid">
                <label for="inputPastMarkPaid" class="small muted">Marcar este serviço como <strong>Pago</strong> ao registrar (opcional)</label>
            </div>

            <div style="margin-top:20px" class="row">
                <button class="btn" type="submit"><i class="fa-solid fa-floppy-disk"></i> Registrar Serviço Passado</button>
                <button class="btn ghost" type="button" onclick="document.getElementById('formPastService').reset(); renderPastServiceOptions(); updatePastDateWarning(); updatePastTimeDetails()">Limpar</button>
            </div>
        </form>
    </section>

    <section id="view-calendar" class="card" style="display:none">
      <h3>Calendário de Agendamentos</h3>
      <div class="row">
        <div style="flex:1">
          <label class="muted small">Escolha uma data</label>
          <input type="date" id="calendarDate" min="2024-01-01" max="2028-12-31" onchange="showDate()" />
        </div>
        <div style="width:250px">
          <label class="muted small">Buscar por cliente</label>
          <input type="text" id="searchClient" placeholder="Digite o nome do cliente" oninput="showDate()" />
        </div>
      </div>
      <div style="margin-top:15px">
        <table id="tableCalendar"><thead><tr><th>Data</th><th>Cliente</th><th>Serviço</th><th>Hora (Início / Saída)</th><th>Valor</th><th>Status</th><th>Ações</th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <section id="view-history" class="card" style="display:none">
      <h3>Histórico Completo</h3>
      <div class="row" style="margin-bottom:15px">
        <div class="col">
          <label class="muted small">Pesquisar por Cliente/Serviço</label>
          <input type="text" id="historySearchInput" placeholder="Digite o nome do cliente ou serviço" oninput="loadHistory()">
        </div>
        <div style="width:150px">
          <label class="muted small">Status</label>
          <select id="historyStatusFilter" onchange="loadHistory()">
            <option value="">Todos</option>
            <option value="pendente">Pendente</option>
            <option value="pago">Pago</option>
          </select>
        </div>
      </div>
      <div class="muted small" id="historyCountLabel">Lista dos agendamentos mais recentes (máx. 200).</div>
      <div style="margin-top:15px">
        <table>
          <thead><tr><th>Data</th><th>Cliente</th><th>Serviço</th><th>Hora (Início / Saída)</th><th>Tempo</th><th>Valor</th><th>Status</th><th>Ações</th></tr></thead>
          <tbody id="tableHistoryBody"></tbody>
        </table>
      </div>
    </section>

    <section id="view-admin" class="card" style="display:none">
      <h3>Área Administrativa e Financeira</h3>

      <h4 style="margin-top:10px">Resumo Financeiro - Hoje (<span id="adminTodayDate"></span>)</h4>
      <div class="daily-summary">
          <div class="daily-stat">
              <div class="label">Entradas do Dia</div>
              <div class="value" id="dailyEntries">R$ 0,00</div>
          </div>
          <div class="daily-stat">
              <div class="label">Despesas do Dia</div>
              <div class="value" id="dailyExpenses">R$ 0,00</div>
          </div>
          <div class="daily-stat">
              <div class="label">Saldo do Dia (Entradas - Saídas)</div>
              <div class="value" id="dailyBalance">R$ 0,00</div>
          </div>
      </div>

      <h4 style="margin-top:0px">Dashboard de Fluxo de Caixa (Total Geral)</h4>
      <div class="finance-grid-main">
        <div class="finance-stat-card in">
          <div class="label">Total de Entradas (Receitas)</div>
          <div class="value" id="dashTotalEntries">R$ 0,00</div>
          <div class="detail">Soma de todos os pagamentos de agendamentos.</div>
        </div>
        <div class="finance-stat-card out">
          <div class="label">Total de Saídas (Despesas)</div>
          <div class="value" id="dashTotalExpenses">R$ 0,00</div>
          <div class="detail">Soma de todas as despesas registradas.</div>
        </div>
        <div class="finance-stat-card bal">
          <div class="label">Saldo Final (Atual)</div>
          <div class="value" id="dashBalance">R$ 0,00</div>
          <div class="detail">Saldo Inicial + Entradas - Saídas.</div>
        </div>
      </div>
      
      <div class="card" style="margin-top:15px">
        <h4>Resumo de Saldo Diário do Mês Atual (<span id="monthlyLabel"></span>)</h4>
        <div style="max-height:400px;overflow-y:auto">
          <table id="monthlySummaryTable">
            <thead>
              <tr>
                <th>Dia</th>
                <th>Data</th>
                <th>Entradas (R$)</th>
                <th>Saídas (R$)</th>
                <th>Saldo Diário (R$)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="grid" style="grid-template-columns:1fr 1fr;gap:15px;margin-top:15px">
        <div class="card">
          <h4>Configurações Gerais e Segurança</h4>
          <label class="muted small">Nome do estabelecimento</label>
          <input type="text" id="brandNameInput">
          <label class="muted small">Logo (opcional)</label>
          <input type="file" id="logoFile" accept="image/*">
          <label class="muted small">Senha administrativa</label>
          <input type="text" id="adminPassInput" placeholder="Deixe vazio para não alterar">
          <div style="margin-top:15px" class="row">
            <button class="btn" onclick="saveConfig()"><i class="fa-solid fa-save"></i> Salvar Configurações</button>
            <button class="btn ghost" onclick="resetConfig()">Resetar Dados</button>
          </div>
        </div>

        <div class="card">
          <h4>Controle de Saldo e Caixa</h4>
          <div class="row">
            <div class="col">
              <div class="muted small">Saldo de Abertura (Caixa Inicial)</div>
              <input type="number" id="initialCash" min="0" step="0.01">
            </div>
            <div style="width:120px;padding-top:20px">
              <button class="btn" onclick="setInitialCash()">Salvar</button>
            </div>
          </div>
          <div class="muted small" style="margin-top:10px">Use esta função para zerar o saldo total.</div>
          <button class="btn ghost" style="margin-top:10px" onclick="clearAllData(true)">Zerar Todo o Fluxo de Caixa (Manter Agendamentos)</button>
        </div>
      </div>

      <div class="card" style="margin-top:15px">
        <h4>Gestão de Serviços e Preços</h4>
        <div class="muted small">Clique em um campo para editar (Nome, Categoria, Preço, Tempo) e use <i class="fa-solid fa-save"></i> para salvar.</div>
        <table id="servicesTable">
            <thead><tr><th>Nome</th><th>Categoria</th><th>Tipo</th><th>Preço</th><th>Tempo (min)</th><th>Ações</th></tr></thead>
            <tbody></tbody>
        </table>
        
        <div style="margin-top:15px">
          <div class="grid" style="grid-template-columns:repeat(5,1fr);gap:8px">
            <input type="text" id="svcName" placeholder="Nome do serviço">
            <select id="svcCategory"><option value="both">Ambos</option><option value="moto">Moto</option><option value="carro">Carro</option></select>
            <select id="svcIsAdd"><option value="false">Principal</option><option value="true">Adicional</option></select>
            <input type="number" id="svcPrice" placeholder="Preço (R$)" min="0" step="0.01">
            <input type="number" id="svcTime" placeholder="Tempo (min)" min="0">
          </div>
          <div style="margin-top:10px" class="row">
            <button class="btn" onclick="addService()"><i class="fa-solid fa-plus"></i> Adicionar Serviço</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:15px">
        <h4>Movimentações e Despesas</h4>
        <div class="grid" style="grid-template-columns:1fr 1fr 1fr;gap:15px">
          <div>
            <label class="muted small">Registrar Nova Despesa</label>
            <input type="text" id="expDesc" placeholder="Descrição da despesa" style="margin-bottom:8px">
            <input type="number" id="expValue" placeholder="Valor (R$)" min="0" step="0.01">
            <div style="margin-top:10px"><button class="btn" onclick="addExpense()"><i class="fa-solid fa-money-bill-transfer"></i> Registrar Despesa</button></div>
          </div>
          <div>
            <label class="muted small">Entradas (Receitas)</label>
            <div id="listEntries" style="max-height:280px;overflow-y:auto;border:1px solid var(--line);padding:8px;border-radius:8px"></div>
          </div>
          <div>
            <label class="muted small">Despesas</label>
            <div id="listExpenses" style="max-height:280px;overflow-y:auto;border:1px solid var(--line);padding:8px;border-radius:8px"></div>
          </div>
        </div>
      </div>

    </section>
    <footer class="muted small">App offline — dados salvos apenas no seu dispositivo. Desenvolvido com sofisticação e controle.</footer>
  </main>
</div>

<div id="editServiceModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div class="card" style="width:450px; padding:20px;">
        <h4 style="margin-top:0;">Editar Agendamento (Admin)</h4>
        <form id="formEditSchedule" onsubmit="saveScheduleEdit(event)">
            <input type="hidden" id="editScheduleId">

            <div class="grid" style="grid-template-columns:1fr 1fr; gap: 15px;">
                <div>
                    <label class="muted small">Cliente (Nome)</label>
                    <input type="text" id="editClientNameInput" required>
                </div>
                <div>
                    <label class="muted small">Veículo</label>
                    <select id="editVehicle" onchange="renderEditServiceOptions(); updateEditServiceDetails();">
                        <option value="moto">Moto</option>
                        <option value="carro">Carro</option>
                    </select>
                </div>
            </div>

            <div class="grid" style="grid-template-columns:1fr 1fr; gap: 15px; margin-top: 15px;">
                <div>
                    <label class="muted small">Data</label>
                    <input type="date" id="editDate" required>
                </div>
                <div>
                    <label class="muted small">Hora de Início</label>
                    <input type="time" id="editTime" required onchange="updateEditServiceDetails()">
                </div>
            </div>

            <div style="margin-top:15px;">
                <label class="muted small">Serviço Principal</label>
                <select id="editService" required onchange="updateEditServiceDetails()"></select>
            </div>
            
            <div style="margin-top:15px;">
                <label class="muted small">Adicionais</label>
                <div id="editAdds" style="display:flex;flex-wrap:wrap;gap:15px;border:1px solid var(--line);padding:10px;border-radius:8px;"></div>
            </div>

            <div style="margin-top:15px;" class="row">
                <div style="flex:1;">
                    <label class="muted small">Duração (minutos)</label>
                    <input type="number" id="editTempoInput" min="0" required oninput="updateEditServiceDetails(true)">
                </div>
                <div style="flex:1;">
                    <label class="muted small">Previsão de Saída</label>
                    <input type="text" id="editEndTime" readonly style="background:#f9f9f9;font-weight:700;color:var(--info);">
                </div>
            </div>

            <div style="margin-top:12px;">
              <label class="muted small">Desconto (%)</label>
              <input type="number" id="editDiscount" min="0" max="100" placeholder="Ex: 10" onchange="updateEditServiceDetails()">
            </div>

            <div style="margin-top:12px;">
                <label class="muted small">Valor Final (Com Desconto)</label>
                <input type="text" id="editValor" readonly style="background:#f9f9f9;font-weight:800;color:var(--accent);">
            </div>

            <div style="margin-top:20px" class="row">
                <button class="btn" type="submit"><i class="fa-solid fa-save"></i> Salvar Edição</button>
                <button class="btn ghost" type="button" onclick="closeEditModal()">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<script>
/* ============================ DATA & DEFAULTS ============================ */
const KEY = 'wap_vupt_app_v3_8'
const DEFAULT = {
  brand: {name:'Wap Vupt', logo:''},
  adminPass: '1234',
  initialCash: 0,
  services: [
    {id:idGen(), name:'Moto Pequena - Lavagem', category:'moto', isAdd:false, price:5.00, time:25},
    {id:idGen(), name:'Moto Grande - Lavagem', category:'moto', isAdd:false, price:7.00, time:25},
    {id:idGen(), name:'Carro - Lavagem + Pretinho', category:'carro', isAdd:false, price:15.00, time:30},
    {id:idGen(), name:'Moto - Hidratação', category:'moto', isAdd:true, price:5.00, time:10},
    {id:idGen(), name:'Moto - Cera', category:'moto', isAdd:true, price:5.00, time:5},
    {id:idGen(), name:'Moto - Verniz', category:'moto', isAdd:true, price:10.00, time:15},
    {id:idGen(), name:'Carro - Aspiração', category:'carro', isAdd:true, price:10.00, time:30},
    {id:idGen(), name:'Carro - Hidratação', category:'carro', isAdd:true, price:10.00, time:30},
    {id:idGen(), name:'Carro - Cera', category:'carro', isAdd:true, price:16.00, time:30},
    {id:idGen(), name:'Carro - Verniz', category:'carro', isAdd:true, price:15.00, time:30},
    {id:idGen(), name:'Gás', category:'both', isAdd:true, price:3.00, time:5},
  ],
  schedules: [],
  entries: [],
  expenses: []
}
function idGen(){ return 'id'+Math.random().toString(36).slice(2,9) }
function load(){ 
  try{ 
    const loadedData = JSON.parse(localStorage.getItem(KEY));
    return loadedData ? {...JSON.parse(JSON.stringify(DEFAULT)), ...loadedData} : JSON.parse(JSON.stringify(DEFAULT));
  }catch{ 
    return JSON.parse(JSON.stringify(DEFAULT)) 
  } 
}
let DATA = load()
function save(){ localStorage.setItem(KEY, JSON.stringify(DATA)); refreshAll() }

/* ============================ UI HELPERS ============================ */
function $(id){ return document.getElementById(id) }
function money(v){ return 'R$ ' + Number(v||0).toFixed(2).replace('.',',') }
function todayStr(){ return new Date().toISOString().slice(0,10) }
function yesterdayStr(){ const d=new Date(); d.setDate(d.getDate()-1); return d.toISOString().slice(0,10) }
function parseTimeToMins(t){ if(!t) return 0; const [h,m]=t.split(':').map(Number); return h*60+m }
function addMinsToTime(t,mins){ const total=parseTimeToMins(t)+mins; const totalMins = ((total%1440)+1440)%1440; const hh=Math.floor(totalMins/60); const mm=totalMins%60; return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}` }
function formatDateBR(dateStr){ const [y,m,d] = dateStr.split('-'); return `${d}/${m}/${y}` }
function applyDiscount(value, percent){ percent = Number(percent) || 0; if(percent <= 0) return Number(value); return Number((value * (1 - (percent/100))).toFixed(2)); }

/* ============================ NAVIGATION ============================ */
function nav(btn){
  document.querySelectorAll('aside .nav-btn').forEach(b=>b.classList.remove('active'))
  btn.classList.add('active')
  const view = btn.dataset.view
  if (view === 'admin') {
    const pass = prompt('🔐 Senha administrativa:'); 
    if(pass === DATA.adminPass){
      ['today','new','past-service','calendar','history','admin'].forEach(v=> $('view-'+v).style.display='none')
      $('view-admin').style.display='block'
      loadAdmin()
    } else { 
      alert('🚫 Senha incorreta!'); 
      document.querySelector('[data-view="today"]').classList.add('active');
      $('view-today').style.display='block';
      loadToday();
      return;
    }
  } else {
    ['today','new','past-service','calendar','history','admin'].forEach(v=> $('view-'+v).style.display='none')
    $('view-'+view).style.display='block'
    if(view==='today') loadToday()
    if(view==='new'){ renderServiceOptions(); updateTimeDetails(); $('clientHistoryContainer').style.display='none'; $('clientHistoryList').innerHTML=''; $('inputDate').value = todayStr(); }
    if(view==='past-service'){ $('inputPastDate').value = yesterdayStr(); renderPastServiceOptions(); updatePastDateWarning(); updatePastTimeDetails(); $('formPastService').reset(); }
    if(view==='calendar'){ $('calendarDate').value = todayStr(); showDate() }
    if(view==='history') loadHistory()
  }
}

/* ============================ BRAND & CLOCK ============================ */
function renderBrand(){ $('titleApp').innerText = DATA.brand.name || 'Wap Vupt'; $('titleApp').title = DATA.brand.name || 'Wap Vupt'; if(DATA.brand.logo){ $('sideLogo').src = DATA.brand.logo; $('sideLogo').style.display='block' } else { $('sideLogo').style.display='none' } }
function updateClock(){ $('clock').innerText = new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}) }
setInterval(updateClock,1000);

/* ============================ FINANCE / BALANCE ============================ */
function calculateBalance(dateStr = null){
  let entries = DATA.entries;
  let expenses = DATA.expenses;
  let initial = DATA.initialCash;
  if (dateStr) {
    const dateFilter = (item) => item.time.startsWith(dateStr);
    entries = entries.filter(dateFilter);
    expenses = expenses.filter(dateFilter);
    initial = 0;
  }
  const totalEntries = entries.reduce((sum, e) => sum + e.value, 0)
  const totalExpenses = expenses.reduce((sum, e) => sum + e.value, 0)
  const currentBalance = initial + totalEntries - totalExpenses
  return { initial: initial, entries: totalEntries, expenses: totalExpenses, balance: currentBalance }
}

function calculateMonthlySummary() {
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const monthlySummary = {};
  const monthPrefix = `${year}-${String(month + 1).padStart(2, '0')}`;
  const monthEntries = DATA.entries.filter(e => e.time.startsWith(monthPrefix));
  const monthExpenses = DATA.expenses.filter(e => e.time.startsWith(monthPrefix));
  for (let day = 1; day <= daysInMonth; day++) {
      const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      const dayEntries = monthEntries.filter(e => e.time.startsWith(dateStr)).reduce((sum, e) => sum + e.value, 0);
      const dayExpenses = monthExpenses.filter(e => e.time.startsWith(dateStr)).reduce((sum, e) => sum + e.value, 0);
      const dayBalance = dayEntries - dayExpenses;
      if (dayEntries > 0 || dayExpenses > 0 || dateStr === todayStr()) {
        monthlySummary[dateStr] = { dateStr, day, entries: dayEntries, expenses: dayExpenses, balance: dayBalance };
      }
  }
  return monthlySummary;
}

function refreshAll(){
  renderBrand()
  const balance = calculateBalance()
  $('dashTotalEntries').innerText = money(balance.entries)
  $('dashTotalExpenses').innerText = money(balance.expenses)
  $('dashBalance').innerText = money(balance.balance)
  const todayBalance = calculateBalance(todayStr())
  $('adminTodayDate').innerText = formatDateBR(todayStr())
  $('dailyEntries').innerText = money(todayBalance.entries)
  $('dailyExpenses').innerText = money(todayBalance.expenses)
  $('dailyBalance').innerText = money(todayBalance.balance)
  const schedulesToday = DATA.schedules.filter(s => s.date === todayStr())
  const collectedToday = schedulesToday.filter(s => s.paid).reduce((sum, s) => sum + s.valor, 0)
  $('collectedToday').innerText = money(collectedToday)
  loadToday()
  renderServicesTable()
  renderEntriesAndExpenses()
  if($('view-admin').style.display === 'block') { renderMonthlySummary(); }
  if($('view-history').style.display === 'block') { loadHistory(); }
}

/* ============================ TODAY VIEW (SCHEDULES) ============================ */
function loadToday(){
  const today = todayStr()
  const schedulesToday = DATA.schedules.filter(s => s.date === today).sort((a,b) => a.time.localeCompare(b.time))
  $('todayLabel').innerText = formatDateBR(today)
  $('todayCount').innerText = `${schedulesToday.length} agendamentos`
  $('rushCount').innerText = schedulesToday.length
  $('pendingCount').innerText = schedulesToday.filter(s => !s.paid).length
  const tbody = $('tableToday').querySelector('tbody'); tbody.innerHTML = ''
  schedulesToday.forEach((s, i) => {
    const service = DATA.services.find(svc => svc.id === s.serviceId) || {name: 'Serviço excluído', price: s.valor, time: s.tempo}
    const endTime = addMinsToTime(s.time, s.tempo);
    const row = tbody.insertRow()
    row.insertCell().innerText = i + 1
    const clientCell = row.insertCell()
    clientCell.innerHTML = `<span class="client-name-clickable" onclick="promptAdminPasswordForEdit('${s.id}')">${s.name}</span>`
    // mostra serviço principal + lista de adicionais completos
    let serviceText = (service.name || 'Serviço')
    if (s.adds && s.adds.length > 0) {
        const addsNames = s.adds.map(addId => {
            const addSvc = DATA.services.find(a => a.id === addId);
            return addSvc ? addSvc.name : 'Adicional';
        });
        serviceText += ' + ' + addsNames.join(' + ');
    }
    // se tiver desconto, mostra também (ex: R$ 45,00 (10% off))
    let displayValor = money(s.valor);
    if (s.discountPercent && Number(s.discountPercent) > 0) {
        displayValor = `${money(s.valor)} (${s.discountPercent}% off)`;
    }
    row.insertCell().innerText = serviceText
    const timeCell = row.insertCell(); timeCell.innerHTML = `<strong>${s.time}</strong> / <span style="color:var(--info)">${endTime}</span>`
    row.insertCell().innerHTML = `<strong>${displayValor}</strong>`
    const statusCell = row.insertCell(); statusCell.className = s.paid ? 'paid' : 'not-paid'; statusCell.innerText = s.paid ? 'Pago' : 'Pendente'
    const actionCell = row.insertCell(); actionCell.className = 'actions'
    if(!s.paid){
      const payBtn = document.createElement('button'); payBtn.className = 'btn btn-sm'; payBtn.innerHTML = '<i class="fa-solid fa-hand-holding-dollar"></i> Pagar'; payBtn.onclick = () => confirmPayment(s.id); actionCell.appendChild(payBtn)
    } else {
      const printBtn = document.createElement('button'); printBtn.className = 'btn ghost btn-sm'; printBtn.innerHTML = '<i class="fa-solid fa-receipt"></i> Nota'; printBtn.onclick = () => printNonFiscalNote(s); actionCell.appendChild(printBtn)
    }
    const cancelBtn = document.createElement('button'); cancelBtn.className = 'btn ghost btn-sm'; cancelBtn.style.color = 'var(--danger)'; cancelBtn.style.borderColor = 'var(--danger)'; cancelBtn.innerHTML = '<i class="fa-solid fa-times"></i>'; cancelBtn.onclick = () => cancelSchedule(s.id); actionCell.appendChild(cancelBtn)
  })
}

/* =========== EDIT / MODAL =========== */
function promptAdminPasswordForEdit(scheduleId) {
    const pass = prompt(`🔐 Digite a Senha Administrativa para editar o agendamento ${scheduleId.substring(2)}:`); 
    if(pass === DATA.adminPass){ editScheduleService(scheduleId); } else if (pass !== null) { alert('🚫 Senha incorreta! A edição não foi autorizada.'); }
}

function renderEditServiceOptions(vehicle = null, selectedServiceId = null, selectedAdds = []) {
    vehicle = vehicle || $('editVehicle').value;
    const mainServices = DATA.services.filter(s => s.isAdd === false && (s.category === vehicle || s.category === 'both'));
    const addServices = DATA.services.filter(s => s.isAdd === true && (s.category === vehicle || s.category === 'both'));
    
    const selectService = $('editService');
    selectService.innerHTML = mainServices.map(s => `<option value="${s.id}" data-price="${s.price}" data-time="${s.time}" ${s.id === selectedServiceId ? 'selected' : ''}>${s.name} (${money(s.price)})</option>`).join('');

    const inputAdds = $('editAdds');
    inputAdds.innerHTML = addServices.map(s => `
      <label class="small" style="display:flex;align-items:center;gap:5px;">
        <input type="checkbox" name="edit-add-on" value="${s.id}" data-price="${s.price}" onchange="updateEditServiceDetails()" ${selectedAdds.includes(s.id) ? 'checked' : ''}>
        ${s.name} (${money(s.price)})
      </label>
    `).join('');
}

function editScheduleService(scheduleId) {
    const schedule = DATA.schedules.find(s => s.id === scheduleId); if (!schedule) return;
    $('editScheduleId').value = scheduleId;
    
    // Preenche campos simples
    $('editClientNameInput').value = schedule.name;
    $('editVehicle').value = schedule.vehicle || 'moto'; // Garante um valor padrão
    $('editDate').value = schedule.date;
    $('editTime').value = schedule.time;
    $('editDiscount').value = schedule.discountPercent || '';

    // Renderiza serviços e adicionais
    renderEditServiceOptions(schedule.vehicle, schedule.serviceId, schedule.adds || []);
    
    // Define a duração no campo de input, forçando o update com base nele
    $('editTempoInput').value = schedule.tempo;
    updateEditServiceDetails(true); // Força a atualização de valor e previsão baseada no TEMPO

    $('editServiceModal').style.display = 'flex';
}

function updateEditServiceDetails(fromTempoInput = false) {
    const serviceId = $('editService').value;
    const adds = Array.from(document.querySelectorAll('#editAdds input[type="checkbox"]:checked')).map(cb => cb.value);
    const discount = Number($('editDiscount').value) || 0;
    const startTime = $('editTime').value;

    let details = getServicePriceAndDuration(serviceId, adds);
    let totalTime = details.tempo;

    if (fromTempoInput) {
        // Se a atualização veio do campo Tempo (duração)
        totalTime = Number($('editTempoInput').value) || 0;
        // O valor base é o valor calculado do serviço, mesmo se o tempo for alterado manualmente
        const final = applyDiscount(details.valor, discount);
        $('editValor').value = money(final);
        $('editTempoInput').value = totalTime;
    } else {
        // Se a atualização veio do Serviço, Adicional ou Desconto
        // O tempo é baseado na soma dos serviços
        const final = applyDiscount(details.valor, discount);
        $('editValor').value = money(final);
        $('editTempoInput').value = totalTime; // Atualiza o campo de duração para refletir o serviço
    }
    
    if (startTime && totalTime > 0) {
        const endTime = addMinsToTime(startTime, totalTime);
        $('editEndTime').value = `${endTime} (${totalTime} min)`;
    } else {
        $('editEndTime').value = `--:-- (${totalTime} min)`;
    }
}

function saveScheduleEdit(e) {
    e.preventDefault();
    const scheduleId = $('editScheduleId').value;
    const schedule = DATA.schedules.find(s => s.id === scheduleId);
    if (!schedule) { alert('Erro: Agendamento não encontrado.'); closeEditModal(); return; }
    
    // Novos dados
    const newName = $('editClientNameInput').value.trim();
    const newVehicle = $('editVehicle').value;
    const newDate = $('editDate').value;
    const newTime = $('editTime').value;
    const newServiceId = $('editService').value;
    const newAdds = Array.from(document.querySelectorAll('#editAdds input[type="checkbox"]:checked')).map(cb => cb.value);
    const newDiscount = Number($('editDiscount').value) || 0;
    const newTempo = Number($('editTempoInput').value) || 0; // Pega o tempo do input (pode ser manual)
    
    // Recalcula o valor base (apenas serviços e adicionais) para aplicar o desconto
    const baseDetails = getServicePriceAndDuration(newServiceId, newAdds);
    const newValor = applyDiscount(baseDetails.valor, newDiscount);

    // Validação de horário
    if (isTimeSlotOccupied(newTime, newTempo, newDate, scheduleId)) { return; }

    // Atualiza o objeto
    schedule.name = newName;
    schedule.vehicle = newVehicle;
    schedule.date = newDate;
    schedule.time = newTime;
    schedule.serviceId = newServiceId;
    schedule.adds = newAdds;
    schedule.tempo = newTempo;
    schedule.discountPercent = newDiscount;
    schedule.valor = newValor;

    // Se já estava pago, atualiza a entrada no caixa com o novo valor
    if (schedule.paid) {
        DATA.entries = DATA.entries.filter(e => e.scheduleId !== scheduleId);
        const paymentDateISO = new Date().toISOString(); 
        DATA.entries.push({ id: idGen(), label: `Agendamento [EDITADO] - ${newName} (${formatDateBR(newDate)})`, value: newValor, time: paymentDateISO, scheduleId: scheduleId });
        alert(`Serviço atualizado. O novo valor de ${money(newValor)} foi registrado no caixa.`);
    } else {
        alert(`Serviço atualizado. Novo valor: ${money(newValor)}.`);
    }
    save(); closeEditModal();
}
function closeEditModal(){ $('editServiceModal').style.display = 'none'; }

/* ============================ PAYMENT / CANCEL ============================ */
function confirmPayment(scheduleId){
  const schedule = DATA.schedules.find(s => s.id === scheduleId); if(!schedule) return;
  const paymentDateISO = new Date().toISOString();
  let msg = `Confirmar o pagamento de ${schedule.name} no valor de ${money(schedule.valor)}?`;
  if (schedule.date !== todayStr()) { msg += `\n\nATENÇÃO: Este agendamento era do dia ${formatDateBR(schedule.date)}.`; }
  if(confirm(msg)){
    // Remove entrada antiga se houver (previne duplicação se o botão for clicado mais de uma vez por engano)
    DATA.entries = DATA.entries.filter(e => e.scheduleId !== scheduleId); 
    schedule.paid = true;
    DATA.entries.push({ id: idGen(), label: `Agendamento - ${schedule.name} (${formatDateBR(schedule.date)})`, value: schedule.valor, time: paymentDateISO, scheduleId: scheduleId })
    save()
    alert('Pagamento confirmado e registrado no caixa!')
    if(confirm('Deseja imprimir a nota não fiscal agora?')){ printNonFiscalNote(schedule); }
  }
}

function togglePaymentStatus(scheduleId){
    const schedule = DATA.schedules.find(s => s.id === scheduleId); if(!schedule) return;
    if (schedule.paid) {
        if(confirm(`Tem certeza que deseja marcar o serviço de ${schedule.name} como PENDENTE (Estornar ${money(schedule.valor)} do caixa)?`)){
            DATA.entries = DATA.entries.filter(e => e.scheduleId !== scheduleId);
            schedule.paid = false;
            save();
            alert(`Status alterado para PENDENTE. Valor estornado do caixa.`);
        }
    } else {
        if(confirm(`Confirmar o pagamento (Mudar para PAGO) do serviço de ${schedule.name} no valor de ${money(schedule.valor)}?`)){
            const paymentDateISO = new Date().toISOString();
            DATA.entries.push({ id: idGen(), label: `Agendamento - ${schedule.name} (${formatDateBR(schedule.date)})`, value: schedule.valor, time: paymentDateISO, scheduleId: scheduleId });
            schedule.paid = true;
            save();
            alert(`Status alterado para PAGO. Valor adicionado ao caixa.`);
        }
    }
}

function cancelSchedule(id) {
    if(confirm('Tem certeza que deseja CANCELAR este agendamento? Ele será removido permanentemente da agenda.')){
        const schedule = DATA.schedules.find(s => s.id === id);
        if (!schedule) return;
        if (schedule.paid) {
             DATA.entries = DATA.entries.filter(e => e.scheduleId !== id);
             alert(`Agendamento cancelado. A entrada de ${money(schedule.valor)} foi estornada/removida do caixa.`);
        } else {
             alert('Agendamento cancelado com sucesso.');
        }
        DATA.schedules = DATA.schedules.filter(s => s.id !== id);
        save();
    }
}

/* ============================ PRINT NOTE ============================ */
function printNonFiscalNote(schedule){
    const service = DATA.services.find(svc => svc.id === schedule.serviceId) || {name: 'Serviço', price: 0}
    const itemsHtml = [];
    // main service
    const mainPrice = (DATA.services.find(s => s.id === schedule.serviceId)?.price) || 0;
    itemsHtml.push(`<div class="item"><span>- ${service.name}</span><span class="value">${money(mainPrice)}</span></div>`);
    if(schedule.adds && schedule.adds.length){
      schedule.adds.forEach(addId => {
        const addSvc = DATA.services.find(s => s.id === addId);
        itemsHtml.push(`<div class="item" style="margin-left:10px;"><span style="font-size:9pt;">+ ${addSvc?.name || 'Adicional'}</span><span style="font-size:9pt;">${money(addSvc?.price || 0)}</span></div>`);
      });
    }
    // summary
    // Calcula o valor total SEM desconto
    const valorBase = (DATA.services.find(s=>s.id===schedule.serviceId)?.price || 0) + (schedule.adds||[]).reduce((acc,id)=> acc + ((DATA.services.find(s=>s.id===id)?.price)||0),0);
    const descontoAplicado = valorBase - schedule.valor;

    const discountLine = schedule.discountPercent && Number(schedule.discountPercent) > 0 ? `<div class="item"><span>Desconto (${schedule.discountPercent}%)</span><span class="value">- ${money(descontoAplicado)}</span></div>` : '';
    const noteContent = `
        <style>
            @media print {
                body { font-family: 'Consolas', monospace; font-size: 10pt; margin: 0; padding: 0; }
                .note { width: 80mm; margin: 0 auto; padding: 10px; border: 1px dashed #333; }
                .header, .footer { text-align: center; margin-bottom: 5px; }
                .item, .total { display: flex; justify-content: space-between; margin-bottom: 2px; }
                .separator { border-top: 1px dashed #999; margin: 5px 0; }
                .value { font-weight: bold; }
            }
        </style>
        <div class="note">
            <div class="header">
                <h3>--- ${DATA.brand.name.toUpperCase()} ---</h3>
                <p style="margin:0;font-size:9pt;">NOTA NÃO FISCAL (SIMPLES)</p>
                <p style="margin:0;font-size:9pt;">${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR')}</p>
            </div>
            <div class="separator"></div>
            <p style="margin:2px 0;">CLIENTE: ${schedule.name}</p>
            <p style="margin:2px 0;">VEÍCULO: ${schedule.vehicle ? schedule.vehicle.toUpperCase() : ''}</p>
            <div class="separator"></div>
            <p style="margin:5px 0 0;">DESCRIÇÃO DOS SERVIÇOS:</p>
            ${itemsHtml.join('')}
            ${discountLine}
            <div class="separator"></div>
            <div class="total">
                <span style="font-size:12pt;">TOTAL PAGO:</span>
                <span class="value" style="font-size:12pt;color:var(--accent);">${money(schedule.valor)}</span>
            </div>
            <div class="separator"></div>
            <div class="footer">
                <p style="margin:0;font-size:8pt;">OBRIGADO PELA PREFERÊNCIA!</p>
                <p style="margin:0;font-size:8pt;">Agendado para: ${formatDateBR(schedule.date)} às ${schedule.time}</p>
            </div>
        </div>
    `;
    const printWindow = window.open('', '_blank', 'width=400,height=600');
    printWindow.document.write(noteContent);
    printWindow.document.close();
    printWindow.print();
}

/* ============================ NEW & PAST (SERVIÇOS E DESCONTO) ============================ */
function getServicePriceAndDuration(serviceId, adds=[]){
  const mainService = DATA.services.find(s => s.id === serviceId)
  let totalValue = mainService ? mainService.price : 0
  let totalTime = mainService ? mainService.time : 0
  adds.forEach(addId => {
    const addService = DATA.services.find(s => s.id === addId)
    if(addService){ totalValue += addService.price; totalTime += addService.time }
  })
  return {valor: Number(totalValue.toFixed(2)), tempo: totalTime}
}

function renderServiceOptions(selectedVehicle = null, selectedServiceId = null, selectedAdds = []){
  const vehicle = selectedVehicle || $('inputVehicle').value
  const mainServices = DATA.services.filter(s => s.isAdd===false && (s.category === vehicle || s.category === 'both'))
  const addServices = DATA.services.filter(s => s.isAdd===true && (s.category === vehicle || s.category === 'both'))
  const selectService = $('inputService')
  selectService.innerHTML = mainServices.map(s => `<option value="${s.id}" data-price="${s.price}" data-time="${s.time}" ${s.id === selectedServiceId ? 'selected' : ''}>${s.name} (${money(s.price)})</option>`).join('')
  const inputAdds = $('inputAdds')
  inputAdds.innerHTML = addServices.map(s => `<label class="small" style="display:flex;align-items:center;gap:5px;"><input type="checkbox" name="add-on" value="${s.id}" data-price="${s.price}" onchange="updateTimeDetails()" ${selectedAdds.includes(s.id) ? 'checked' : ''}>${s.name} (${money(s.price)})</label>`).join('')
}

function renderPastServiceOptions(selectedVehicle = null, selectedServiceId = null, selectedAdds = []){
  const vehicle = selectedVehicle || $('inputPastVehicle').value
  const mainServices = DATA.services.filter(s => s.isAdd===false && (s.category === vehicle || s.category === 'both'))
  const addServices = DATA.services.filter(s => s.isAdd===true && (s.category === vehicle || s.category === 'both'))
  const selectService = $('inputPastService')
  selectService.innerHTML = mainServices.map(s => `<option value="${s.id}" data-price="${s.price}" data-time="${s.time}" ${s.id === selectedServiceId ? 'selected' : ''}>${s.name} (${money(s.price)})</option>`).join('')
  const inputAdds = $('inputPastAdds')
  inputAdds.innerHTML = addServices.map(s => `<label class="small" style="display:flex;align-items:center;gap:5px;"><input type="checkbox" name="past-add-on" value="${s.id}" data-price="${s.price}" onchange="updatePastTimeDetails()" ${selectedAdds.includes(s.id) ? 'checked' : ''}>${s.name} (${money(s.price)})</label>`).join('')
}

function updatePastTimeDetails(){
    const serviceId = $('inputPastService').value;
    const adds = Array.from(document.querySelectorAll('#inputPastAdds input[type="checkbox"]:checked')).map(cb => cb.value);
    const startTime = $('inputPastTime').value;
    const details = getServicePriceAndDuration(serviceId, adds);
    const totalTime = details.tempo;
    const discount = Number($('inputPastDiscount').value) || 0;
    const finalValue = applyDiscount(details.valor, discount);
    $('inputPastTotalWithDiscount').value = money(finalValue);
    if (totalTime > 0) {
        if(startTime){
            const endTime = addMinsToTime(startTime, totalTime);
            $('pastEndTime').value = `${endTime} (${totalTime} min)`;
        } else {
            $('pastEndTime').value = `Total: ${totalTime} min`;
        }
    } else {
        $('pastEndTime').value = `0 min`;
    }
}

/* NOVO: Mostra um alerta se a data do serviço passado for anterior à de hoje. */
function updatePastDateWarning() {
    const pastDate = $('inputPastDate').value; const today = todayStr(); const warning = $('pastDateWarning');
    if (pastDate < today) { warning.style.display = 'flex'; } else { warning.style.display = 'none'; }
}

/* Cria serviço no passado: POR PADRÃO fica PENDENTE, mas há checkbox para marcar pago */
function createPastSchedule(e){
    e.preventDefault()
    const name = $('inputPastName').value
    const vehicle = $('inputPastVehicle').value
    const serviceId = $('inputPastService').value
    const date = $('inputPastDate').value
    const time = $('inputPastTime').value || '00:00';
    const adds = Array.from(document.querySelectorAll('#inputPastAdds input[type="checkbox"]:checked')).map(cb => cb.value)
    const markPaid = $('inputPastMarkPaid').checked
    const discount = Number($('inputPastDiscount').value) || 0
    if(!serviceId){ alert('Selecione um serviço principal.'); return }
    const serviceDetails = getServicePriceAndDuration(serviceId, adds)
    const finalValue = applyDiscount(serviceDetails.valor, discount)
    const newSchedule = {
      id: idGen(),
      name, vehicle, serviceId, adds, date, time,
      valor: finalValue,
      tempo: serviceDetails.tempo,
      discountPercent: discount || 0,
      paid: markPaid ? true : false,
      createdAt: new Date().toISOString()
    }
    DATA.schedules.push(newSchedule)
    if(markPaid){
        // Usa a data do agendamento para a entrada no caixa
        const paymentDateISO = date + new Date().toISOString().slice(10); 
        DATA.entries.push({ id: idGen(), label: `Serviço Realizado (Histórico) - ${name} (${formatDateBR(date)})`, value: newSchedule.valor, time: paymentDateISO, scheduleId: newSchedule.id })
    }
    save()
    if(markPaid){
      alert(`✅ Serviço Histórico de ${name} (em ${formatDateBR(date)}) registrado e valor de ${money(newSchedule.valor)} adicionado ao caixa do dia ${formatDateBR(date)}!`)
    } else {
      alert(`✅ Serviço Histórico de ${name} (em ${formatDateBR(date)}) registrado como PENDENTE. Marque como pago quando efetuar o recebimento.`)
    }
    $('formPastService').reset()
    $('inputPastDate').value = yesterdayStr();
    renderPastServiceOptions()
    updatePastDateWarning()
    updatePastTimeDetails()
}

/* Carrega histórico rápido do cliente (novo agendamento) */
function loadClientHistory(clientName) {
    const container = $('clientHistoryContainer'); const list = $('clientHistoryList');
    if (clientName.length < 3) { container.style.display = 'none'; list.innerHTML = ''; return; }
    const normalizedName = clientName.toLowerCase().trim();
    const schedules = DATA.schedules.filter(s => s.name.toLowerCase().includes(normalizedName)).sort((a,b) => b.createdAt.localeCompare(a.createdAt)).slice(0,5);
    if (schedules.length === 0) { container.style.display = 'none'; list.innerHTML = ''; return; }
    list.innerHTML = schedules.map(s => {
        const service = DATA.services.find(svc => svc.id === s.serviceId) || { name: 'Serviço Excluído' };
        const addsCount = s.adds ? s.adds.length : 0; const addsText = addsCount > 0 ? ` +${addsCount} adicional${addsCount > 1 ? 's' : ''}` : '';
        return `<div class="client-history-item" onclick="fillFormFromHistory('${s.id}')"><div class="service-name">${service.name}${addsText}</div><div class="details"><span>${formatDateBR(s.date)}</span><span>${s.time}</span><span style="color:var(--accent);">${money(s.valor)}</span></div></div>`;
    }).join('');
    container.style.display = 'block';
}

/* Preenche forms com histórico */
function fillFormFromHistory(scheduleId) {
    const s = DATA.schedules.find(s => s.id === scheduleId); if (!s) return;
    const currentView = document.querySelector('aside .nav-btn.active').dataset.view;
    let inputNameEl, inputVehicleEl, renderFunc, updateFunc;
    if (currentView === 'new') { inputNameEl = $('inputName'); inputVehicleEl = $('inputVehicle'); renderFunc = renderServiceOptions; updateFunc = updateTimeDetails; }
    else if (currentView === 'past-service') { inputNameEl = $('inputPastName'); inputVehicleEl = $('inputPastVehicle'); renderFunc = renderPastServiceOptions; updateFunc = updatePastTimeDetails; $('inputPastDate').value = todayStr(); $('inputPastTime').value = ''; updatePastDateWarning(); }
    else { return; }
    inputNameEl.value = s.name; inputVehicleEl.value = s.vehicle; renderFunc(s.vehicle, s.serviceId, s.adds); if(currentView==='new') { $('inputDiscount').value = s.discountPercent || ''; } else { $('inputPastDiscount').value = s.discountPercent || ''; }
    updateFunc(); alert(`📋 Campos de Serviço e Veículo preenchidos com base no agendamento de ${formatDateBR(s.date)}.`);
}

/* Atualiza previsão e calcula valor com desconto no form Novo */
function updateTimeDetails(){
    const serviceId = $('inputService').value; const adds = Array.from(document.querySelectorAll('#inputAdds input[type="checkbox"]:checked')).map(cb => cb.value); const startTime = $('inputTime').value;
    const details = getServicePriceAndDuration(serviceId, adds); const totalTime = details.tempo;
    const discount = Number($('inputDiscount').value) || 0; const finalValue = applyDiscount(details.valor, discount);
    $('inputTotalWithDiscount').value = money(finalValue);
    if (startTime && totalTime > 0) { const endTime = addMinsToTime(startTime, totalTime); $('endTime').value = `${endTime} (${totalTime} min)`; } else { $('endTime').value = `--:-- (0 min)`; }
}

/* Verifica sobreposição de horário */
function isTimeSlotOccupied(newStartTime, durationMins, newDate, excludeId = null){
    if(!newStartTime || durationMins <= 0) return false;
    const newStartTimeMins = parseTimeToMins(newStartTime); const newEndTimeMins = newStartTimeMins + durationMins;
    const existingSchedules = DATA.schedules.filter(s => s.date === newDate && s.id !== excludeId);
    for(const s of existingSchedules){
        const existingStartTimeMins = parseTimeToMins(s.time); const existingEndTimeMins = existingStartTimeMins + s.tempo;
        const startsDuring = newStartTimeMins >= existingStartTimeMins && newStartTimeMins < existingEndTimeMins;
        const endsDuring = newEndTimeMins > existingStartTimeMins && newEndTimeMins <= existingEndTimeMins;
        const encompasses = newStartTimeMins <= existingStartTimeMins && newEndTimeMins >= existingEndTimeMins;
        const engulfed = existingStartTimeMins <= newStartTimeMins && existingEndTimeMins >= newEndTimeMins;
        if(startsDuring || endsDuring || encompasses || engulfed){
            const newFinalTime = addMinsToTime(newStartTime, durationMins);
            const existingEndTime = addMinsToTime(s.time, s.tempo);
            alert(`🚫 ERRO: O horário das ${newStartTime}h às ${newFinalTime}h se sobrepõe ao agendamento de ${s.name} (das ${s.time}h às ${existingEndTime}h).`);
            return true;
        }
    }
    return false;
}

/* Cria novo agendamento (desconto aplicado ao total serviço+adicionais) */
function createSchedule(e){
  e.preventDefault()
  const name = $('inputName').value; const vehicle = $('inputVehicle').value; const serviceId = $('inputService').value; const date = $('inputDate').value; const time = $('inputTime').value; const adds = Array.from(document.querySelectorAll('#inputAdds input[type="checkbox"]:checked')).map(cb => cb.value)
  if(!serviceId){ alert('Selecione um serviço principal.'); return }
  const serviceDetails = getServicePriceAndDuration(serviceId, adds)
  if (isTimeSlotOccupied(time, serviceDetails.tempo, date)) { return; }
  const discount = Number($('inputDiscount').value) || 0
  const finalValue = applyDiscount(serviceDetails.valor, discount)
  const newSchedule = { id: idGen(), name, vehicle, serviceId, adds, date, time, valor: finalValue, tempo: serviceDetails.tempo, discountPercent: discount || 0, paid: false, createdAt: new Date().toISOString() }
  DATA.schedules.push(newSchedule); save()
  alert(`Agendamento para ${name} em ${formatDateBR(date)} às ${time} confirmado! Previsão de saída: ${addMinsToTime(time, serviceDetails.tempo)}. Total: ${money(newSchedule.valor)}`)
  $('formNew').reset(); renderServiceOptions(); updateTimeDetails(); $('clientHistoryContainer').style.display = 'none'; $('clientHistoryList').innerHTML = '';
}

/* ============================ CALENDAR VIEW ============================ */
function showDate(){
  const date = $('calendarDate').value; const search = $('searchClient').value.toLowerCase().trim()
  const schedulesDate = DATA.schedules.filter(s => s.date === date && s.name.toLowerCase().includes(search)).sort((a,b) => a.time.localeCompare(b.time))
  const tbody = $('tableCalendar').querySelector('tbody'); tbody.innerHTML = ''
  schedulesDate.forEach((s, i) => {
    const service = DATA.services.find(svc => svc.id === s.serviceId) || {name: 'Serviço excluído'}
    const endTime = addMinsToTime(s.time, s.tempo);
    const row = tbody.insertRow(); row.insertCell().innerText = formatDateBR(s.date); row.insertCell().innerText = s.name
    // mostra serviço + adicionais
    let serviceText = service.name; if (s.adds && s.adds.length>0){ const addsNames=s.adds.map(id=> (DATA.services.find(x=>x.id===id)?.name)||'Adicional'); serviceText += ' + ' + addsNames.join(' + '); }
    row.insertCell().innerText = serviceText
    const timeCell = row.insertCell(); timeCell.innerHTML = `<strong>${s.time}</strong> / <span style="color:var(--info)">${endTime}</span>`
    row.insertCell().innerText = money(s.valor)
    const statusCell = row.insertCell(); statusCell.className = s.paid ? 'paid' : 'not-paid'; statusCell.innerText = s.paid ? 'Pago' : 'Pendente'
    const actionCell = row.insertCell(); const cancelBtn = document.createElement('button'); cancelBtn.className = 'btn ghost btn-sm'; cancelBtn.style.color = 'var(--danger)'; cancelBtn.style.borderColor = 'var(--danger)'; cancelBtn.innerHTML = '<i class="fa-solid fa-times"></i> Cancelar'; cancelBtn.onclick = () => cancelSchedule(s.id); actionCell.appendChild(cancelBtn)
  })
}

/* ============================ HISTORY VIEW ============================ */
function loadHistory(){
  const search = $('historySearchInput').value.toLowerCase().trim(); const statusFilter = $('historyStatusFilter').value;
  const filteredSchedules = DATA.schedules.filter(s => {
    const service = DATA.services.find(svc => svc.id === s.serviceId) || {name: 'Serviço Excluído'};
    const nameMatch = s.name.toLowerCase().includes(search) || service.name.toLowerCase().includes(search);
    const statusMatch = (statusFilter === 'pago' && s.paid) || (statusFilter === 'pendente' && !s.paid) || (statusFilter === '');
    return nameMatch && statusMatch;
  });
  const sortedSchedules = filteredSchedules.sort((a,b) => b.createdAt.localeCompare(a.createdAt)).slice(0, 200);
  $('historyCountLabel').innerText = `Exibindo ${sortedSchedules.length} de ${filteredSchedules.length} agendamentos encontrados.`;
  const tbody = $('tableHistoryBody'); tbody.innerHTML = ''
  sortedSchedules.forEach((s) => {
    const service = DATA.services.find(svc => svc.id === s.serviceId) || {name: 'Serviço excluído', price: s.valor, time: s.tempo}
    const endTime = addMinsToTime(s.time, s.tempo);
    const row = tbody.insertRow()
    row.insertCell().innerText = formatDateBR(s.date)
    row.insertCell().innerHTML = `<span class="client-name-clickable" onclick="promptAdminPasswordForEdit('${s.id}')">${s.name}</span>`
    let serviceText = service.name
    if (s.adds && s.adds.length > 0) {
        const addsNames = s.adds.map(addId => { const addSvc = DATA.services.find(a => a.id === addId); return addSvc ? addSvc.name : 'Adicional'; });
        serviceText += ' + ' + addsNames.join(' + ');
    }
    row.insertCell().innerText = serviceText
    const timeCell = row.insertCell(); timeCell.innerHTML = `<strong>${s.time}</strong> / <span style="color:var(--info)">${endTime}</span>`
    row.insertCell().innerText = `${s.tempo} min`
    row.insertCell().innerText = money(s.valor)
    const statusCell = row.insertCell(); statusCell.className = s.paid ? 'paid' : 'not-paid'; statusCell.innerText = s.paid ? 'Pago' : 'Pendente'
    const actionCell = row.insertCell(); actionCell.className = 'actions'
    
    // NOVO: Toggle de status de pagamento
    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'btn btn-sm';
    toggleBtn.style.backgroundColor = s.paid ? 'var(--danger)' : 'var(--success)';
    toggleBtn.style.color = 'white';
    toggleBtn.innerHTML = s.paid ? '<i class="fa-solid fa-rotate-left"></i> Pend.' : '<i class="fa-solid fa-check"></i> Pago';
    toggleBtn.onclick = () => togglePaymentStatus(s.id);
    actionCell.appendChild(toggleBtn);

    const cancelBtn = document.createElement('button'); 
    cancelBtn.className = 'btn ghost btn-sm'; 
    cancelBtn.style.color = 'var(--danger)'; 
    cancelBtn.style.borderColor = 'var(--danger)'; 
    cancelBtn.innerHTML = '<i class="fa-solid fa-times"></i>'; 
    cancelBtn.onclick = () => cancelSchedule(s.id); 
    actionCell.appendChild(cancelBtn);

  })
}

/* ============================ ADMIN / CONFIG ============================ */
function loadAdmin(){
  const balance = calculateBalance()
  $('initialCash').value = balance.initial.toFixed(2)
  $('brandNameInput').value = DATA.brand.name || ''
  $('adminPassInput').value = ''
  $('dashTotalEntries').innerText = money(balance.entries)
  $('dashTotalExpenses').innerText = money(balance.expenses)
  $('dashBalance').innerText = money(balance.balance)
  const todayBalance = calculateBalance(todayStr())
  $('adminTodayDate').innerText = formatDateBR(todayStr())
  $('dailyEntries').innerText = money(todayBalance.entries)
  $('dailyExpenses').innerText = money(todayBalance.expenses)
  $('dailyBalance').innerText = money(todayBalance.balance)
  renderMonthlySummary(); renderServicesTable(); renderEntriesAndExpenses()
}
function renderMonthlySummary() {
  const summary = calculateMonthlySummary(); const tbody = $('monthlySummaryTable').querySelector('tbody'); tbody.innerHTML = ''; const today = new Date(); $('monthlyLabel').innerText = today.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
  let totalEntradas = 0; let totalSaidas = 0;
  const sortedSummary = Object.values(summary).sort((a, b) => a.dateStr.localeCompare(b.dateStr));
  sortedSummary.forEach(item => {
    const row = tbody.insertRow();
    const date = new Date(item.dateStr + 'T12:00:00'); const dayName = date.toLocaleDateString('pt-BR', { weekday: 'short' });
    row.insertCell().innerText = dayName; row.insertCell().innerText = formatDateBR(item.dateStr);
    row.insertCell().innerText = money(item.entries); totalEntradas += item.entries;
    row.insertCell().innerText = money(item.expenses).replace('R$ -', '-R$ '); totalSaidas += item.expenses;
    const balanceCell = row.insertCell(); balanceCell.innerText = money(item.balance); balanceCell.style.color = item.balance >= 0 ? 'var(--success)' : 'var(--danger)';
  });
  const totalRow = tbody.insertRow(); totalRow.style.backgroundColor = 'var(--line)';
  totalRow.insertCell().innerHTML = `<strong>TOTAL</strong>`; totalRow.insertCell().innerHTML = `<strong>${today.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' })}</strong>`;
  totalRow.insertCell().innerHTML = `<strong>${money(totalEntradas)}</strong>`; totalRow.insertCell().innerHTML = `<strong>${money(totalSaidas)}</strong>`;
  const totalBalance = totalEntradas - totalSaidas; const totalBalanceCell = totalRow.insertCell(); totalBalanceCell.innerHTML = `<strong>${money(totalBalance)}</strong>`; totalBalanceCell.style.color = totalBalance >= 0 ? 'var(--success)' : 'var(--danger)';
}
function setInitialCash(){ const newCash = Number($('initialCash').value); if(isNaN(newCash) || newCash < 0){ alert('Valor inválido.'); return } DATA.initialCash = newCash; save(); alert(`Saldo inicial definido para ${money(newCash)}.`) }
function saveConfig(){ DATA.brand.name = $('brandNameInput').value; const newPass = $('adminPassInput').value; if(newPass){ DATA.adminPass = newPass } const logoFile = $('logoFile').files[0]; if(logoFile){ const reader = new FileReader(); reader.onload = function(e){ DATA.brand.logo = e.target.result; save(); alert('Configurações salvas (incluindo logo e/ou senha).') }; reader.readAsDataURL(logoFile) } else { save(); alert('Configurações salvas (exceto logo e/ou senha).') } }
function resetConfig(){ if(confirm('Tem certeza que deseja apagar TODOS os dados (agendamentos, caixa, serviços)? Esta ação é irreversível!')){ localStorage.removeItem(KEY); DATA = JSON.parse(JSON.stringify(DEFAULT)); save(); alert('Todos os dados foram resetados.'); location.reload() } }
function clearAllData(keepSchedules = false){ let message = 'ATENÇÃO: Deseja zerar todo o fluxo de caixa (Saldo Inicial, Entradas e Despesas)?'; if (keepSchedules) { message += '\n\nOs AGENDAMENTOS serão MANTIDOS (mas terão o status de PENDENTE para o novo ciclo de caixa).'; } else { message += '\n\nOs AGENDAMENTOS também serão APAGADOS.' } if(confirm(message)){ DATA.initialCash = 0; DATA.entries = []; DATA.expenses = []; if(!keepSchedules){ DATA.schedules = []; } else { DATA.schedules.forEach(s => s.paid = false); } save(); alert('Fluxo de caixa zerado com sucesso!'); loadAdmin(); } }

/* ======================= GESTÃO DE SERVIÇOS (COM EDIÇÃO) ======================= */
function renderServicesTable(){ const tbody = $('servicesTable').querySelector('tbody'); tbody.innerHTML = ''; DATA.services.forEach(s => { const row = tbody.insertRow(); row.id = `svc-${s.id}`; const nameCell = row.insertCell(); nameCell.innerText = s.name; nameCell.onclick = () => enableEdit(row, s.id, 'name', nameCell, 'text', s.name)
  const catCell = row.insertCell(); catCell.innerText = s.category === 'moto' ? 'Moto' : s.category === 'carro' ? 'Carro' : 'Ambos'; catCell.onclick = () => enableEdit(row, s.id, 'category', catCell, 'select', s.category, [{value:'both', text:'Ambos'}, {value:'moto', text:'Moto'}, {value:'carro', text:'Carro'}])
  const isAddCell = row.insertCell(); isAddCell.innerText = s.isAdd ? 'Adicional' : 'Principal'; isAddCell.onclick = () => enableEdit(row, s.id, 'isAdd', isAddCell, 'select', s.isAdd.toString(), [{value:'false', text:'Principal'}, {value:'true', text:'Adicional'}])
  const priceCell = row.insertCell(); priceCell.innerText = money(s.price); priceCell.onclick = () => enableEdit(row, s.id, 'price', priceCell, 'number', s.price.toFixed(2), null, '0.01')
  const timeCell = row.insertCell(); timeCell.innerText = `${s.time} min`; timeCell.onclick = () => enableEdit(row, s.id, 'time', timeCell, 'number', s.time)
  const actionCell = row.insertCell(); actionCell.className = 'actions'
  const delBtn = document.createElement('button'); delBtn.className = 'btn ghost btn-sm'; delBtn.style.color = 'var(--danger)'; delBtn.style.borderColor = 'var(--danger)'; delBtn.innerHTML = '<i class="fa-solid fa-trash-can"></i> Apagar'; delBtn.onclick = () => deleteService(s.id); actionCell.appendChild(delBtn)
}) }

function enableEdit(row, id, field, cell, type, currentValue, options = null, step = '1') {
    if (row.classList.contains('edit-mode')) return;
    row.classList.add('edit-mode'); cell.innerHTML = '';
    let input;
    if (type === 'select' && options) { input = document.createElement('select'); options.forEach(opt => { const option = document.createElement('option'); option.value = opt.value; option.text = opt.text; if (opt.value.toString() === currentValue.toString()) option.selected = true; input.appendChild(option); }); }
    else { input = document.createElement('input'); input.type = type; input.value = currentValue; if (type === 'number') { input.min = '0'; input.step = step; } }
    cell.appendChild(input);
    const actionCell = row.cells[5]; actionCell.innerHTML = '';
    const saveBtn = document.createElement('button'); saveBtn.className = 'btn btn-sm'; saveBtn.innerHTML = '<i class="fa-solid fa-save"></i>'; saveBtn.onclick = () => saveEdit(id, field, input.value, row); actionCell.appendChild(saveBtn);
    const cancelBtn = document.createElement('button'); cancelBtn.className = 'btn ghost btn-sm'; cancelBtn.innerHTML = '<i class="fa-solid fa-times"></i>'; cancelBtn.onclick = () => renderServicesTable(); actionCell.appendChild(cancelBtn);
    input.focus();
}

function saveEdit(id, field, newValue, row) {
    const service = DATA.services.find(s => s.id === id); if (!service) return;
    if (field === 'price' || field === 'time') { newValue = Number(newValue); if (isNaN(newValue) || newValue < 0) { alert(`Valor inválido para ${field}.`); renderServicesTable(); return; } } else if (field === 'isAdd') { newValue = newValue === 'true'; } else if (field === 'name' && !newValue.trim()) { alert('O nome do serviço não pode ser vazio.'); renderServicesTable(); return; }
    service[field] = newValue;
    // Se mudou preço ou tempo, recalcula os agendamentos PENDENTES que usam este serviço
    if(field === 'price' || field === 'time'){ 
        DATA.schedules.filter(s => s.serviceId === id && !s.paid).forEach(s => { 
            const details = getServicePriceAndDuration(s.serviceId, s.adds); 
            // Recalcula o valor com o desconto já existente (para manter a coerência)
            s.valor = applyDiscount(details.valor, s.discountPercent || 0); 
            s.tempo = details.tempo; 
        }); 
    }
    save(); renderServicesTable();
}

function addService(){ const name = $('svcName').value.trim(); const category = $('svcCategory').value; const isAdd = $('svcIsAdd').value === 'true'; const price = Number($('svcPrice').value); const time = Number($('svcTime').value); if(!name || isNaN(price) || price < 0 || isNaN(time) || time < 0){ alert('Preencha todos os campos corretamente.'); return } DATA.services.push({ id: idGen(), name, category, isAdd, price, time }); save(); $('svcName').value = $('svcPrice').value = $('svcTime').value = ''; alert('Serviço adicionado.') }

function deleteService(id){ const today = todayStr(); const futureSchedules = DATA.schedules.filter(s => s.serviceId === id && s.date >= today); let confirmationMessage = 'Tem certeza que deseja excluir este serviço? '; if (futureSchedules.length > 0) { confirmationMessage += `\n\nATENÇÃO: Existem ${futureSchedules.length} agendamentos futuros usando este serviço! Excluir pode comprometer o histórico.`; } else { confirmationMessage += 'Esta ação é irreversível.' } if(confirm(confirmationMessage)){ DATA.services = DATA.services.filter(s => s.id !== id); save(); alert('Serviço excluído.') } }

/* ============================ MOVIMENTOS (ENTRADAS/SAÍDAS) ============================ */
function renderEntriesAndExpenses(){
  const listEntries = $('listEntries'); const listExpenses = $('listExpenses');
  listEntries.innerHTML = DATA.entries.sort((a,b) => b.time.localeCompare(a.time)).slice(0, 10).map(e => `<div class="small" style="display:flex;justify-content:space-between;border-bottom:1px dashed #eee;padding:4px 0;"><span>${e.label.substring(0, 30)}...</span><span style="color:var(--success);font-weight:700;">+${money(e.value)}</span></div>`).join('')
  listExpenses.innerHTML = DATA.expenses.sort((a,b) => b.time.localeCompare(a.time)).slice(0, 10).map(e => `<div class="small" style="display:flex;justify-content:space-between;border-bottom:1px dashed #eee;padding:4px 0;"><span>${e.label.substring(0, 30)}...</span><span style="color:var(--danger);font-weight:700;">-${money(e.value)}</span></div>`).join('')
}
function addExpense(){ const desc = $('expDesc').value.trim(); const value = Number($('expValue').value); if(!desc || isNaN(value) || value <= 0){ alert('Descreva a despesa e informe um valor válido.'); return } DATA.expenses.push({ id: idGen(), label: `Despesa - ${desc}`, value: value, time: new Date().toISOString() }); save(); $('expDesc').value = $('expValue').value = ''; alert('Despesa registrada.') }

/* ============================ EXPORT / BACKUP / PRINT TODAY ============================ */
function downloadJson(){ const dataStr = JSON.stringify(DATA, null, 2); const blob = new Blob([dataStr], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `wap_vupt_backup_${todayStr()}.json`; a.click(); URL.revokeObjectURL(url); alert('Backup (JSON) baixado. Guarde em um local seguro.') }
function exportData(){ let csvContent = 'Data;Cliente;Servico;Valor;Pago;Data_Completa\n'; DATA.schedules.forEach(s => { const service = DATA.services.find(svc => svc.id === s.serviceId) || {name: 'Serviço Excluido'}; csvContent += `${formatDateBR(s.date)};${s.name};"${service.name}";${s.valor.toFixed(2).replace('.',',')};${s.paid ? 'Sim' : 'Não'};${s.createdAt}\n` }); const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `wap_vupt_export_${todayStr()}.csv`; a.click(); URL.revokeObjectURL(url); alert('Dados exportados (CSV) com sucesso.') }
function printToday(){ const content = document.querySelector('#tableToday').outerHTML; const today = todayStr(); const printWindow = window.open('', '_blank', 'width=800,height=600'); printWindow.document.write(`<html><head><title>Agenda ${formatDateBR(today)}</title><style>table{width:100%;border-collapse:collapse;margin-top:20px}th,td{padding:8px;border:1px solid #ccc;text-align:left;font-size:12px}th{background:#f0f0f0}.paid{color:green} .not-paid{color:red}</style></head><body><h2>Agenda de Agendamentos - ${formatDateBR(today)}</h2>${content}</body></html>`); printWindow.document.close(); printWindow.print(); }

/* ============================ INICIALIZAÇÃO ============================ */
document.addEventListener('DOMContentLoaded', () => {
    renderBrand(); updateClock(); refreshAll();
    $('calendarDate').value = todayStr(); $('inputDate').value = todayStr();
    renderServiceOptions(); renderPastServiceOptions();
    document.querySelectorAll('#inputService, #inputTime, #inputDate, #inputDiscount').forEach(el => el.addEventListener('change', updateTimeDetails));
    document.querySelectorAll('#inputPastService, #inputPastTime, #inputPastDate, #inputPastDiscount').forEach(el => el.addEventListener('change', () => { updatePastTimeDetails(); updatePastDateWarning(); }));
});
</script>
</body>
</html>
